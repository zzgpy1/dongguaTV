<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- æ ¸å¿ƒï¼šä¸å‘é€ Referrer -->
    <meta name="referrer" content="no-referrer">
    <title>Eè§†ç•Œ</title>

    <!-- PWA Setup -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.png" type="image/png">
    <meta name="theme-color" content="#141414">

    <!-- æœ¬åœ°é™æ€èµ„æº (é¿å… CDN è®¿é—®é—®é¢˜) -->
    <link href="libs/css/bootstrap.min.css" rel="stylesheet">
    <link href="libs/css/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="libs/css/fontawesome.min.css">

    <script data-cfasync="false" src="libs/js/hls.min.js"></script>
    <script data-cfasync="false" src="libs/js/DPlayer.min.js"></script>
    <script data-cfasync="false" src="libs/js/vue.global.prod.min.js"></script>
    <script data-cfasync="false" src="libs/js/bootstrap.bundle.min.js"></script>

    <style>
        :root {
            --bg-color: #141414;
            --panel-bg: #1f1f1f;
            --accent: #e50914;
            --text-main: #ffffff;
            --text-sub: #b3b3b3;
            --border: rgba(255, 255, 255, 0.1);
        }

        [v-cloak] {
            display: none !important;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            min-height: 100vh;
            padding-bottom: 60px;
            overflow-x: hidden;
        }

        /* ========== ğŸ¬ DPlayer é«˜çº§ç¾åŒ–æ ·å¼ ========== */

        /* å±è”½ DPlayer é»˜è®¤æç¤º */
        .dplayer-notice,
        .dplayer-notice-list {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        /* æ’­æ”¾å™¨å®¹å™¨åœ†è§’ */
        #dplayer {
            border-radius: 12px;
            overflow: hidden;
        }

        /* 1. æ¯›ç»ç’ƒæ§åˆ¶æ æ•ˆæœ */
        .dplayer-controller {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.4) 60%, transparent 100%) !important;
            backdrop-filter: blur(10px) saturate(150%) !important;
            -webkit-backdrop-filter: blur(10px) saturate(150%) !important;
        }

        /* 2. è¿›åº¦æ¡ç¾åŒ– - æ¸å˜æ•ˆæœ */
        .dplayer-bar-wrap .dplayer-played {
            background: linear-gradient(90deg, #e50914, #ff4757, #ff6b81) !important;
        }

        /* è¿›åº¦æ¡é«˜åº¦ */
        .dplayer-bar-wrap {
            height: 4px !important;
            transition: none !important;
        }

        /* 3. è¿›åº¦æ¡æ‹–åŠ¨ç‚¹ - å‘å…‰æ•ˆæœ */
        .dplayer-bar-wrap .dplayer-thumb {
            background: #fff !important;
            box-shadow: 0 0 12px rgba(229, 9, 20, 0.9), 0 0 25px rgba(229, 9, 20, 0.5) !important;
            transform: scale(1.3) !important;
            border: 2px solid rgba(255, 255, 255, 0.9) !important;
        }

        /* 4. æ§åˆ¶æŒ‰é’®ç¾åŒ– */
        .dplayer-icons .dplayer-icon {
            transition: all 0.2s ease !important;
        }

        .dplayer-icons .dplayer-icon:hover {
            transform: scale(1.15) !important;
            background: rgba(255, 255, 255, 0.1) !important;
            border-radius: 6px !important;
        }

        /* 5. å¤§æ’­æ”¾æŒ‰é’®ç¾åŒ– */
        .dplayer-bezel-icon {
            background: rgba(229, 9, 20, 0.9) !important;
            border-radius: 50% !important;
            box-shadow: 0 0 40px rgba(229, 9, 20, 0.6) !important;
        }

        /* 6. éŸ³é‡æ¡ç¾åŒ– */
        .dplayer-volume-bar-wrap .dplayer-volume-bar .dplayer-volume-bar-inner {
            background: linear-gradient(90deg, #e50914, #ff6b81) !important;
        }

        /* 7. è®¾ç½®é¢æ¿æ¯›ç»ç’ƒæ•ˆæœ */
        .dplayer-setting-box {
            background: rgba(20, 20, 20, 0.95) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6) !important;
            overflow: hidden !important;
        }

        .dplayer-setting-box .dplayer-setting-item {
            transition: background 0.2s ease !important;
        }

        .dplayer-setting-box .dplayer-setting-item:hover {
            background: rgba(229, 9, 20, 0.3) !important;
        }

        /* 8. åŠ è½½åŠ¨ç”»ç¾åŒ– */
        .dplayer-loading-icon {
            filter: drop-shadow(0 0 15px rgba(229, 9, 20, 0.6));
        }

        .dplayer-loading-icon svg path {
            fill: #e50914 !important;
        }

        /* 9. é¡¶éƒ¨ä¿¡æ¯æ æ¸å˜ */
        .dplayer-info-panel {
            background: rgba(20, 20, 20, 0.95) !important;
            backdrop-filter: blur(15px) !important;
            border-radius: 10px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* 10. å³é”®èœå•ç¾åŒ– */
        .dplayer-menu {
            background: rgba(20, 20, 20, 0.95) !important;
            backdrop-filter: blur(20px) !important;
            border-radius: 10px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
            overflow: hidden !important;
        }

        .dplayer-menu-item:hover {
            background: rgba(229, 9, 20, 0.4) !important;
        }

        /* 11. æ—¶é—´æ˜¾ç¤ºç¾åŒ– */
        .dplayer-ptime,
        .dplayer-dtime {
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5) !important;
        }

        /* 12. åŒå‡»å¿«è¿›/å¿«é€€åŒºåŸŸæ ·å¼ */
        .dplayer-seek-hint {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            color: #fff;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            z-index: 100;
        }

        .dplayer-seek-hint.show {
            opacity: 1;
            animation: seekPulse 0.4s ease;
        }

        .dplayer-seek-hint.left {
            left: 15%;
        }

        .dplayer-seek-hint.right {
            right: 15%;
        }

        .dplayer-seek-hint i {
            font-size: 28px;
        }

        @keyframes seekPulse {
            0% {
                transform: translateY(-50%) scale(0.8);
                opacity: 0;
            }

            50% {
                transform: translateY(-50%) scale(1.1);
                opacity: 1;
            }

            100% {
                transform: translateY(-50%) scale(1);
                opacity: 1;
            }
        }

        /* 13. å€é€ŸæŒ‡ç¤ºå™¨ */
        .dplayer-speed-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(229, 9, 20, 0.9);
            color: #fff;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 50;
        }

        .dplayer-speed-indicator.show {
            opacity: 1;
        }

        /* é•¿æŒ‰å¿«è¿›è„‰å†²åŠ¨ç”» */
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1.05);
            }
        }

        /* 14. å…¨å±æ—¶çš„æ ·å¼è°ƒæ•´ */
        .dplayer-fulled #dplayer,
        .dplayer-full #dplayer {
            border-radius: 0 !important;
        }

        /* ========== ğŸ¨ DPlayer å›¾æ ‡ç°ä»£åŒ–ç¾åŒ– ========== */

        /* 15. æ‰€æœ‰ SVG å›¾æ ‡åŸºç¡€æ ·å¼ */
        .dplayer-icon svg {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .dplayer-icon svg path {
            fill: rgba(255, 255, 255, 0.9) !important;
            transition: fill 0.2s ease !important;
        }

        .dplayer-icon:hover svg path {
            fill: #ff6b81 !important;
        }

        /* 16. æ’­æ”¾/æš‚åœæŒ‰é’®ç‰¹æ®Šé«˜äº®ä¸åŠ¨æ•ˆ */
        .dplayer-icon.dplayer-play-icon {
            background: linear-gradient(135deg, rgba(229, 9, 20, 0.4), rgba(255, 107, 129, 0.2)) !important;
            border-radius: 50% !important;
            padding: 8px !important;
            margin: 0 5px !important;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
        }

        .dplayer-icon.dplayer-play-icon:hover {
            background: linear-gradient(135deg, rgba(229, 9, 20, 0.8), rgba(255, 107, 129, 0.6)) !important;
            box-shadow: 0 0 20px rgba(229, 9, 20, 0.6) !important;
            transform: scale(1.15) !important;
        }

        .dplayer-icon.dplayer-play-icon svg {
            width: 22px !important;
            height: 22px !important;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.2));
        }

        /* 30. æ‰‹æœºç«¯ä¸­å¤®äº¤äº’æŒ‰é’® (è‡ªå®šä¹‰è¦†ç›–å±‚) - ä¸ç”µè„‘ç«¯ç»Ÿä¸€æ ·å¼ */
        .mobile-play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: 75px;
            height: 75px;
            background: linear-gradient(135deg, rgba(229, 9, 20, 0.9), rgba(180, 0, 15, 0.85));
            backdrop-filter: blur(12px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow:
                0 0 40px rgba(229, 9, 20, 0.5),
                0 0 80px rgba(229, 9, 20, 0.25),
                inset 0 2px 12px rgba(255, 255, 255, 0.2),
                0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .mobile-play-overlay.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
            animation: mobileOverlayAppear 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* å½“æ§åˆ¶æ éšè—æ—¶ï¼Œè¿™ä¸ªæŒ‰é’®ä¹Ÿå¼ºåˆ¶éšè— */
        .dplayer-hide-controller .mobile-play-overlay {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        .mobile-play-overlay i {
            color: #fff;
            font-size: 30px;
            filter: drop-shadow(0 3px 5px rgba(0, 0, 0, 0.4));
            margin-left: 5px;
            /* æ’­æ”¾å›¾æ ‡è§†è§‰ä¿®æ­£ */
        }

        .mobile-play-overlay.pause-state i {
            margin-left: 0;
        }

        .mobile-play-overlay:active {
            transform: translate(-50%, -50%) scale(0.92);
        }

        /* è„‰å†²å…‰ç¯æ•ˆæœ */
        .mobile-play-overlay::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid rgba(229, 9, 20, 0.5);
            animation: mobilePulse 1.8s ease-out infinite;
            pointer-events: none;
        }

        @keyframes mobileOverlayAppear {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }

            60% {
                transform: translate(-50%, -50%) scale(1.08);
            }

            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes mobilePulse {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* 31. ç”µè„‘ç«¯ä¸­å¤®æ’­æ”¾/æš‚åœæŒ‰é’® (è‡ªå®šä¹‰è¦†ç›–å±‚) */
        .desktop-play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, rgba(229, 9, 20, 0.9), rgba(180, 0, 15, 0.85));
            backdrop-filter: blur(12px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow:
                0 0 50px rgba(229, 9, 20, 0.5),
                0 0 100px rgba(229, 9, 20, 0.3),
                inset 0 2px 15px rgba(255, 255, 255, 0.2),
                0 10px 40px rgba(0, 0, 0, 0.4);
            cursor: pointer;
        }

        .desktop-play-overlay.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
            animation: desktopOverlayAppear 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .desktop-play-overlay:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow:
                0 0 70px rgba(229, 9, 20, 0.7),
                0 0 140px rgba(229, 9, 20, 0.4),
                inset 0 2px 20px rgba(255, 255, 255, 0.3);
        }

        .desktop-play-overlay:active {
            transform: translate(-50%, -50%) scale(0.95);
        }

        .desktop-play-overlay i {
            color: #fff;
            font-size: 36px;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.4));
            margin-left: 6px;
            /* æ’­æ”¾å›¾æ ‡è§†è§‰ä¿®æ­£ */
        }

        .desktop-play-overlay.pause-state i {
            margin-left: 0;
        }

        /* è„‰å†²å…‰ç¯æ•ˆæœ */
        .desktop-play-overlay::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid rgba(229, 9, 20, 0.6);
            animation: desktopPulse 2s ease-out infinite;
            pointer-events: none;
        }

        @keyframes desktopOverlayAppear {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }

            60% {
                transform: translate(-50%, -50%) scale(1.1);
            }

            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes desktopPulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            100% {
                transform: scale(1.6);
                opacity: 0;
            }
        }

        /* ä»…åœ¨ç”µè„‘ç«¯æ˜¾ç¤º */
        @media (max-width: 768px) {
            .desktop-play-overlay {
                display: none !important;
            }
        }

        /* 17. éŸ³é‡æŒ‰é’®ç¾åŒ– */
        .dplayer-icon.dplayer-volume-icon {
            padding: 6px !important;
            border-radius: 8px !important;
        }

        .dplayer-icon.dplayer-volume-icon:hover {
            background: rgba(255, 255, 255, 0.15) !important;
        }

        /* 18. è®¾ç½®æŒ‰é’®é½¿è½®æ—‹è½¬åŠ¨ç”» */
        .dplayer-icon.dplayer-setting-icon svg {
            transition: transform 0.4s ease !important;
        }

        .dplayer-icon.dplayer-setting-icon:hover svg {
            transform: rotate(60deg) !important;
        }

        /* 19. å…¨å±æŒ‰é’®æ”¾å¤§åŠ¨ç”» */
        .dplayer-icon.dplayer-full-icon,
        .dplayer-icon.dplayer-full-in-icon {
            padding: 6px !important;
            border-radius: 8px !important;
        }

        .dplayer-icon.dplayer-full-icon:hover,
        .dplayer-icon.dplayer-full-in-icon:hover {
            background: rgba(255, 255, 255, 0.15) !important;
        }

        /* 20. å›¾æ ‡é¢œè‰²æ¸å˜æ•ˆæœ */
        .dplayer-icons .dplayer-icon:hover svg path {
            fill: #ff6b81 !important;
            transition: fill 0.2s ease;
        }

        /* 21. æ§åˆ¶æ¡æŒ‰é’®é—´è·ä¼˜åŒ– */
        .dplayer-icons.dplayer-icons-right .dplayer-icon {
            margin: 0 3px !important;
        }

        /* 22. ä¸­å¤®å¤§æ’­æ”¾æŒ‰é’® */
        .dplayer-bezel-icon {
            width: 70px !important;
            height: 70px !important;
            background: linear-gradient(135deg, rgba(229, 9, 20, 0.95), rgba(180, 0, 15, 0.9)) !important;
            border-radius: 50% !important;
            box-shadow:
                0 0 40px rgba(229, 9, 20, 0.6),
                0 0 80px rgba(229, 9, 20, 0.3),
                inset 0 2px 10px rgba(255, 255, 255, 0.2) !important;
            border: 2px solid rgba(255, 255, 255, 0.2) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s ease !important;
        }

        .dplayer-bezel-icon:hover {
            transform: scale(1.1) !important;
            box-shadow:
                0 0 60px rgba(229, 9, 20, 0.8),
                0 0 100px rgba(229, 9, 20, 0.4) !important;
        }

        .dplayer-bezel-icon svg {
            width: 32px !important;
            height: 32px !important;
        }

        .dplayer-bezel-icon svg path {
            fill: #fff !important;
        }

        /* 23. å€é€Ÿé€‰æ‹©å™¨æ ·å¼ */
        .dplayer-setting-speed-item {
            transition: all 0.2s ease !important;
            border-radius: 6px !important;
            margin: 2px 5px !important;
        }

        .dplayer-setting-speed-item:hover {
            background: rgba(229, 9, 20, 0.4) !important;
            transform: translateX(5px) !important;
        }

        .dplayer-setting-speed-item.dplayer-setting-speed-current {
            background: linear-gradient(90deg, rgba(229, 9, 20, 0.6), transparent) !important;
            color: #ff6b81 !important;
            font-weight: bold !important;
        }

        /* 24. åŠ è½½åŠ¨ç”»è‡ªå®šä¹‰ */
        .dplayer-loading-icon svg {
            width: 60px !important;
            height: 60px !important;
        }

        .dplayer-loading-icon svg circle {
            stroke: #e50914 !important;
            stroke-width: 3 !important;
        }

        /* 25. è¿›åº¦æ¡æ—¶é—´é¢„è§ˆ */
        .dplayer-bar-time {
            background: rgba(20, 20, 20, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            border-radius: 8px !important;
            padding: 6px 12px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5) !important;
            font-weight: 600 !important;
            color: #fff !important;
        }

        /* 26. è®¾ç½®é¢æ¿æ ·å¼ä¿®å¤ - ä»…ä¿®å¤ç‚¹å‡»é—®é¢˜ï¼Œä¸æ”¹å˜å¸ƒå±€ */
        /* è®¾ç½®èœå•å±‚çº§ - ç¡®ä¿åœ¨é®ç½©å±‚ä¹‹ä¸Š */
        .dplayer-setting-box {
            z-index: 30000 !important;
        }

        /* è®¾ç½®èœå•å†…éƒ¨å…ƒç´ å¯ç‚¹å‡» */
        .dplayer-setting-box * {
            pointer-events: auto !important;
        }

        /* å…¨å±æ—¶åŠè‡ªåŠ¨éšè—æ—¶æ§åˆ¶æ å®Œå…¨éšè— */
        .dplayer-fulled .dplayer-controller,
        .dplayer-full .dplayer-controller,
        .dplayer-hide-controller .dplayer-controller {
            opacity: 0 !important;
            visibility: hidden !important;
            transform: translateY(100%) !important;
            bottom: -50px !important;
            transition: all 0.3s ease !important;
            pointer-events: none !important;
        }

        /* å…¨å±æ—¶åŠè‡ªåŠ¨éšè—æ—¶è¿›åº¦æ¡ä¹Ÿå®Œå…¨éšè— */
        .dplayer-fulled .dplayer-bar-wrap,
        .dplayer-full .dplayer-bar-wrap,
        .dplayer-fulled .dplayer-bar,
        .dplayer-full .dplayer-bar,
        .dplayer-fulled .dplayer-thumb,
        .dplayer-full .dplayer-thumb,
        .dplayer-fulled .dplayer-bar-time,
        .dplayer-full .dplayer-bar-time,
        .dplayer-hide-controller .dplayer-bar-wrap,
        .dplayer-hide-controller .dplayer-bar-time,
        .dplayer-hide-controller .dplayer-thumb {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        .dplayer-fulled:hover .dplayer-controller,
        .dplayer-full:hover .dplayer-controller {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
            bottom: 0 !important;
            pointer-events: auto !important;
        }

        .dplayer-fulled:hover .dplayer-bar-wrap,
        .dplayer-full:hover .dplayer-bar-wrap {
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* å•å‡»è§¦å‘æ˜¾ç¤ºæ§åˆ¶æ  */
        .dplayer-controller.dplayer-controller-show {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
            bottom: 0 !important;
            pointer-events: auto !important;
        }

        .dplayer-controller-show .dplayer-bar-wrap {
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* DPlayer ç”µè„‘ç«¯ä¸­å¤®æ’­æ”¾/æš‚åœæŒ‰é’® - ç°ä»£åŒ–åŠ¨æ•ˆ */
        @media (min-width: 769px) {
            .dplayer-bezel-icon {
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                width: 80px !important;
                height: 80px !important;
                background: linear-gradient(135deg, rgba(229, 9, 20, 0.9), rgba(180, 0, 15, 0.85)) !important;
                backdrop-filter: blur(10px) !important;
                border-radius: 50% !important;
                border: 3px solid rgba(255, 255, 255, 0.25) !important;
                box-shadow:
                    0 0 40px rgba(229, 9, 20, 0.6),
                    0 0 80px rgba(229, 9, 20, 0.3),
                    inset 0 2px 15px rgba(255, 255, 255, 0.2),
                    0 8px 32px rgba(0, 0, 0, 0.4) !important;
                animation: bezelAppear 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
            }

            .dplayer-bezel-icon:hover {
                transform: scale(1.1) !important;
                box-shadow:
                    0 0 60px rgba(229, 9, 20, 0.8),
                    0 0 120px rgba(229, 9, 20, 0.4),
                    inset 0 2px 20px rgba(255, 255, 255, 0.3) !important;
            }

            .dplayer-bezel-icon:active {
                transform: scale(0.95) !important;
            }

            .dplayer-bezel-icon svg {
                width: 36px !important;
                height: 36px !important;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)) !important;
            }

            .dplayer-bezel-icon svg path {
                fill: #fff !important;
            }

            /* å‡ºç°åŠ¨ç”» */
            @keyframes bezelAppear {
                0% {
                    opacity: 0;
                    transform: scale(0.5);
                }

                50% {
                    opacity: 1;
                    transform: scale(1.1);
                }

                100% {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            /* è„‰å†²å‘å…‰æ•ˆæœ */
            .dplayer-bezel-icon::before {
                content: '';
                position: absolute;
                width: 100%;
                height: 100%;
                border-radius: 50%;
                background: transparent;
                border: 2px solid rgba(229, 9, 20, 0.5);
                animation: bezelPulse 1.5s ease-out infinite;
                pointer-events: none;
            }

            @keyframes bezelPulse {
                0% {
                    transform: scale(1);
                    opacity: 0.8;
                }

                100% {
                    transform: scale(1.5);
                    opacity: 0;
                }
            }
        }

        /* éšè—çŠ¶æ€ */
        .dplayer-bezel-icon.dplayer-bezel-icon-hide {
            display: none !important;
            animation: none !important;
        }

        /* 27. éšè—é»˜è®¤å›¾æ ‡ï¼Œä½¿ç”¨è‡ªå®šä¹‰è¦†ç›–å±‚ */
        /* éšè— DPlayer é»˜è®¤çš„ç§»åŠ¨ç«¯æ’­æ”¾æŒ‰é’® */
        .dplayer-mobile-play {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        /* å®Œå…¨éšè—åŸç”Ÿ Bezel å›¾æ ‡ (æ‰€æœ‰å°ºå¯¸)ï¼Œä½¿ç”¨è‡ªå®šä¹‰è¦†ç›–å±‚ */
        .dplayer-bezel-icon {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        @media (max-width: 768px) {
            .dplayer-icon {
                padding: 10px !important;
                min-width: 44px !important;
                min-height: 44px !important;
            }
        }

        /* å…¨å±€æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #141414;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* å¯¼èˆª */
        .navbar-custom {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            padding: 15px 4%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.9) 0%, transparent 100%);
            transition: 0.3s;
        }

        .navbar-custom.scrolled {
            background: #141414;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        }

        .brand {
            font-size: 26px;
            font-weight: 800;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
        }

        /* Hero */
        .carousel-item {
            height: 70vh;
            background-color: #000;
        }

        .hero-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center top;
            transition: transform 10s ease;
            mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
        }

        .carousel-item.active .hero-bg {
            transform: scale(1.05);
        }

        .hero-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, #141414 0%, transparent 60%), linear-gradient(to right, rgba(0, 0, 0, 0.8) 0%, transparent 50%);
            display: flex;
            align-items: center;
            padding-left: 5%;
        }

        .hero-content {
            max-width: 600px;
            margin-top: 60px;
            animation: fadeInUp 0.8s;
        }

        .hero-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-block;
            margin-bottom: 15px;
            backdrop-filter: blur(5px);
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 900;
            line-height: 1.1;
            margin-bottom: 15px;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
        }

        .hero-desc {
            font-size: 1.1rem;
            color: #ddd;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            margin-bottom: 25px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .btn-play {
            background: #fff;
            color: #000;
            border: none;
            padding: 10px 30px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-play:hover {
            transform: scale(1.05);
        }

        .btn-info {
            background: rgba(109, 109, 110, 0.7);
            color: #fff;
            border: none;
            padding: 10px 30px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.2s;
            backdrop-filter: blur(5px);
        }

        .btn-info:hover {
            background: rgba(109, 109, 110, 0.5);
        }

        @media(max-width: 768px) {
            .carousel-item {
                height: 55vh;
            }

            .hero-title {
                font-size: 2.2rem;
            }

            .btn-play,
            .btn-info {
                padding: 8px 20px;
                font-size: 1rem;
            }
        }

        /* æœç´¢æ¡† */
        .search-section {
            position: sticky;
            top: 10px;
            /* å¸é¡¶æ—¶ä½äº Navbar å†…éƒ¨ */
            margin-top: -35px;
            z-index: 1001;
            /* é«˜äº Navbar */
            padding: 0 4%;
            /* å¯¹é½ Navbar Padding */
            margin-bottom: 30px;
            pointer-events: none;
        }

        .search-box-wrapper {
            pointer-events: auto;
            background: rgba(20, 20, 20, 0.95);
            /* åŠ æ·±èƒŒæ™¯ï¼Œé˜²æ­¢é€è§†å¹²æ‰° */
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            /* æ›´åœ†æ¶¦ */
            display: flex;
            align-items: center;
            transition: 0.3s;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            /* æ’‘æ»¡ */
            max-width: none;
            margin: 0 auto;
        }

        .search-box-wrapper.compact {
            max-width: 280px;
            height: 40px;
            margin-right: 0;
            /* å³å¯¹é½ */
            margin-left: auto;
            background: rgba(40, 40, 40, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .search-box-wrapper.compact .search-input {
            height: 40px;
            font-size: 14px;
        }

        .search-box-wrapper.compact .search-icon {
            font-size: 14px;
            padding: 0 12px;
        }

        .btn-top {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #e50914, #b20710);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            z-index: 1000;
            border: none;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .btn-top.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .btn-top:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 15px 30px rgba(229, 9, 20, 0.5);
        }



        .search-box-wrapper:focus-within {
            border-color: var(--accent);
            background: #000;
        }

        .search-icon {
            padding: 0 20px;
            color: #888;
            font-size: 18px;
            cursor: pointer;
        }

        .search-input {
            width: 100%;
            height: 60px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 18px;
            outline: none;
        }

        /* åˆ†ç±»å¯¼èˆªæ  */
        .category-nav-container {
            display: flex;
            overflow-x: auto;
            padding: 20px 4%;
            gap: 20px;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE/Edge */
        }

        .category-nav-container::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .category-item {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            width: 70px;
            transition: transform 0.2s;
        }

        .category-item:hover {
            transform: translateY(-5px);
        }

        .category-item span {
            font-size: 12px;
            color: #aaa;
            font-weight: 500;
        }

        .category-item:hover span {
            color: #fff;
        }

        .cat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        /* åˆ—è¡¨é€šç”¨ */
        .section-container {
            padding: 0 5%;
            margin-bottom: 40px;
            min-height: 100px;
            /* ç¡®ä¿ Intersection Observer èƒ½æ£€æµ‹åˆ°è¿›å…¥è§†å£ */
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-line {
            width: 4px;
            height: 22px;
            background: var(--accent);
            border-radius: 2px;
            margin-right: 12px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
            margin: 0;
            line-height: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            font-size: 1.1rem;
            opacity: 0.7;
        }

        /* æ»šåŠ¨å®¹å™¨ */
        .scroll-container {
            position: relative;
        }

        .hot-row {
            display: flex;
            gap: 14px;
            overflow-x: auto;
            padding-bottom: 20px;
            scroll-behavior: smooth;
            /* æ·»åŠ æ»šåŠ¨æ•æ‰ï¼Œè®©æ»šåŠ¨æ›´è‡ªç„¶ */
            scroll-snap-type: x proximity;
            -webkit-overflow-scrolling: touch;
        }

        .hot-row>.hot-card,
        .hot-row>.history-card {
            scroll-snap-align: start;
        }

        .hot-row::-webkit-scrollbar {
            height: 0px;
        }

        /* æ»šåŠ¨æŒ‰é’® */
        .scroll-btn {
            position: absolute;
            top: 35%;
            transform: translateY(-50%);
            width: 36px;
            height: 80px;
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(50, 50, 50, 0.9) 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
            opacity: 0.6;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .scroll-btn:hover {
            background: linear-gradient(135deg, rgba(229, 9, 20, 0.9) 0%, rgba(180, 0, 15, 0.85) 100%);
            opacity: 1;
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 6px 20px rgba(229, 9, 20, 0.4);
        }

        .scroll-btn.left {
            left: -5px;
            border-radius: 0 8px 8px 0;
        }

        .scroll-btn.right {
            right: -5px;
            border-radius: 8px 0 0 8px;
        }

        @media (max-width: 768px) {
            .scroll-btn {
                display: none;
                /* ç§»åŠ¨ç«¯éšè—ï¼Œä½¿ç”¨æ‰‹æŒ‡æ»‘åŠ¨ */
            }
        }

        .hot-card {
            min-width: 150px;
            width: 150px;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
        }

        .hot-card:hover {
            transform: scale(1.08);
            z-index: 10;
        }

        /* å†å²å¡ç‰‡ - ä¸éš hover ç¼©æ”¾ï¼Œåªæœ‰å†…å®¹ç¼©æ”¾ */
        .history-card {
            min-width: 150px;
            width: 150px;
            cursor: pointer;
            position: relative;
            padding: 3px;
        }

        .history-card .poster-wrap {
            transition: transform 0.3s;
        }

        .history-card:hover .poster-wrap {
            transform: scale(1.05);
        }

        /* åˆ é™¤æŒ‰é’®å›ºå®šåœ¨å¡ç‰‡å³ä¸Šè§’ */
        .history-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 20;
            width: 22px;
            height: 22px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
        }

        .history-delete-btn i {
            color: #fff;
            font-size: 10px;
        }

        .history-card:hover .history-delete-btn {
            opacity: 1;
        }

        .history-delete-btn:hover {
            background: rgba(229, 9, 20, 0.9) !important;
        }

        /* ç§»åŠ¨ç«¯ï¼šå§‹ç»ˆæ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
        @media (max-width: 768px),
        (hover: none) {
            .history-delete-btn {
                opacity: 0.8 !important;
            }
        }

        /* æ’­æ”¾å›¾æ ‡è¦†ç›–å±‚ */
        .play-icon-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: rgba(229, 9, 20, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .play-icon-overlay i {
            color: #fff;
            font-size: 14px;
            margin-left: 3px;
        }

        .history-card:hover .play-icon-overlay {
            opacity: 1;
        }

        /* æ‚¬åœæ—¶æ˜¾ç¤ºåˆ é™¤æŒ‰é’®å’Œæ’­æ”¾å›¾æ ‡ (hot-card å…¼å®¹) */
        .hot-card:hover .history-delete-btn {
            opacity: 1 !important;
        }

        .hot-card:hover .play-icon-overlay {
            opacity: 1 !important;
        }

        .poster-wrap {
            width: 100%;
            aspect-ratio: 2/3;
            border-radius: 6px;
            overflow: hidden;
            background: #222;
            position: relative;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border);
        }

        .poster-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.5s;
        }

        .rank-badge {
            position: absolute;
            top: -12px;
            left: -8px;
            font-size: 64px;
            font-weight: 900;
            color: #141414;
            -webkit-text-stroke: 2px #666;
            font-family: impact, sans-serif;
            text-shadow: 2px 2px 0px #eee;
            z-index: 10;
            pointer-events: none;
            line-height: 1;
        }

        .rating-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            color: #46d369;
            font-weight: bold;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(70, 211, 105, 0.3);
        }

        .poster-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #333 0%, #111 100%);
            padding: 5px;
            text-align: center;
        }

        .fallback-text {
            font-size: 12px;
            color: #999;
        }

        .movie-name {
            margin-top: 10px;
            font-size: 14px;
            color: #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
            font-weight: 500;
        }

        .movie-date {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 2px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
            min-height: 300px;
        }

        .result-card {
            cursor: pointer;
            transition: 0.2s;
        }

        .result-card:hover {
            transform: translateY(-5px);
        }

        /* â˜…â˜…â˜… æ’­æ”¾é¡µé‡æ„ï¼šå½±é™¢æ¨¡å¼ â˜…â˜…â˜… */
        .detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #141414;
            z-index: 9999;
            display: none;
            overflow-y: auto;
        }

        .detail-overlay.active {
            display: block;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .close-btn {
            position: fixed;
            top: 25px;
            right: 30px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            cursor: pointer;
            z-index: 10005;
            backdrop-filter: blur(10px);
            transition: 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }

        /* å¸ƒå±€å®¹å™¨ */
        .player-layout {
            max-width: 1200px;
            margin: 0 auto;
            padding: 90px 4% 50px;
        }

        /* è§†é¢‘åŒºåŸŸ */
        .player-box {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        /* è§†é¢‘ä¿¡æ¯æ  */
        .video-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .video-title {
            font-size: 2.2rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .video-meta {
            color: #888;
            font-size: 14px;
        }

        /* æŠ•å±æŒ‰é’® */
        .btn-cast {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            color: #fff;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
        }

        .btn-cast:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* æ§åˆ¶åŒºåŸŸ (ä¸‹åŠéƒ¨åˆ†) */
        .controls-area {
            background: #1f1f1f;
            border-radius: 12px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* çº¿è·¯é€‰æ‹© (æ¨ªå‘æ»šåŠ¨) */
        .panel-title {
            font-size: 14px;
            color: #888;
            font-weight: 700;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .source-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
        }

        .source-pill {
            padding: 8px 16px;
            border-radius: 6px;
            background: #2a2a2a;
            border: 1px solid #333;
            color: #ccc;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .source-pill:hover {
            background: #333;
            border-color: #666;
            color: #fff;
        }

        .source-pill.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
            box-shadow: 0 4px 15px rgba(229, 9, 20, 0.3);
        }

        /* é€‰é›† (å¤§ç½‘æ ¼) */
        .ep-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            /* è‡ªé€‚åº”å®½åº¦ï¼Œæœ€å°100px */
            gap: 12px;
        }

        .ep-btn {
            background: #2a2a2a;
            border: 1px solid transparent;
            color: #ddd;
            padding: 12px 5px;
            text-align: center;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ep-btn:hover {
            background: #333;
            color: #fff;
            border-color: #555;
        }

        .ep-btn.active {
            background: #fff;
            color: #000;
            font-weight: bold;
            border-color: #fff;
        }

        /* çŠ¶æ€ç¯ */
        .latency-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .dot-green {
            background: #46d369;
            box-shadow: 0 0 5px #46d369;
        }

        .dot-yellow {
            background: #ffcc00;
        }

        .dot-red {
            background: #ff453a;
        }

        /* å±•å¼€/æ”¶èµ·æŒ‰é’® */
        .expand-toggle {
            font-size: 13px;
            color: #888;
            cursor: pointer;
            margin-left: 15px;
            transition: color 0.2s;
            white-space: nowrap;
        }

        .expand-toggle:hover {
            color: #fff;
        }

        .expand-toggle i {
            margin-left: 4px;
            font-size: 11px;
            transition: transform 0.3s;
        }

        .expand-toggle.expanded i {
            transform: rotate(180deg);
        }

        /* ç½‘æ ¼å±•å¼€å¸ƒå±€ - ä½¿ç”¨ flexbox ä¿æŒå›ºå®šå¡ç‰‡å®½åº¦ */
        .grid-expanded {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            /* ä¸å•è¡Œæ»šåŠ¨å®¹å™¨çš„ gap ä¸€è‡´ */
        }

        .grid-expanded .hot-card {
            /* ä¿æŒä¸å•è¡Œæ»šåŠ¨æ—¶ç›¸åŒçš„å›ºå®šå®½åº¦ */
            min-width: 150px;
            width: 150px;
            flex-shrink: 0;
        }

        /* åˆ†é¡µæ§åˆ¶ */
        .pagination-controls {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 25px 0;
        }

        .page-btn {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .page-info {
            color: #888;
            font-size: 13px;
            min-width: 100px;
            text-align: center;
        }

        .page-info .page-num {
            color: #fff;
            font-weight: 600;
            font-size: 15px;
        }

        .footer {
            text-align: center;
            font-size: 12px;
            color: #444;
            margin-top: 80px;
            padding-bottom: 20px;
        }

        /* ç”µå½±è¯¦æƒ…å¼¹çª— */
        .info-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .info-modal {
            position: relative;
            max-width: 800px;
            width: 100%;
            background: #181818;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .info-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            font-size: 16px;
        }

        .info-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .info-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 250px;
            background-size: cover;
            background-position: center;
            opacity: 0.4;
        }

        .info-modal-backdrop::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent, #181818);
        }

        .info-modal-content {
            position: relative;
            display: flex;
            gap: 25px;
            padding: 30px;
            padding-top: 180px;
        }

        .info-modal-poster {
            flex-shrink: 0;
            width: 180px;
        }

        .info-modal-poster img {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        .info-modal-details {
            flex: 1;
        }

        .info-modal-details h2 {
            font-size: 1.8rem;
            margin-bottom: 12px;
            color: #fff;
        }

        .info-modal-meta {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #aaa;
            margin-bottom: 15px;
        }

        .info-rating {
            color: #ffc107;
            font-weight: bold;
        }

        .info-overview {
            color: #bbb;
            font-size: 14px;
            line-height: 1.7;
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .info-modal-btns {
            display: flex;
            gap: 12px;
        }

        @media (max-width: 600px) {
            .info-modal-content {
                flex-direction: column;
                padding-top: 200px;
                text-align: center;
            }

            .info-modal-poster {
                width: 120px;
                margin: 0 auto;
            }

            .info-modal-meta {
                justify-content: center;
            }

            .info-modal-btns {
                justify-content: center;
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Loading Screen */
        .app-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            /* Deep dark background */
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }

        .app-loader.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loader-logo {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(45deg, #e50914, #ff5151);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
            letter-spacing: 2px;
            animation: pulse 2s infinite;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #e50914;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        /* Password Protection Screen */
        .password-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .password-screen.hidden {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }

        .password-container {
            background: rgba(30, 30, 40, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 50px 40px;
            width: 100%;
            max-width: 420px;
            margin: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 100px rgba(229, 9, 20, 0.1);
            animation: floatIn 0.8s ease-out;
        }

        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .password-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .password-logo-text {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, #e50914, #ff5151);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }

        .password-logo-subtitle {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            margin-top: 10px;
        }

        .password-input-group {
            position: relative;
            margin-bottom: 25px;
        }

        .password-input {
            width: 100%;
            padding: 18px 50px 18px 20px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
            outline: none;
        }

        .password-input:focus {
            border-color: #e50914;
            box-shadow: 0 0 20px rgba(229, 9, 20, 0.2);
        }

        .password-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            font-size: 18px;
            transition: color 0.2s;
        }

        .password-toggle:hover {
            color: #fff;
        }

        .password-submit {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #e50914 0%, #b20710 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .password-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(229, 9, 20, 0.4);
        }

        .password-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .password-error {
            background: rgba(229, 9, 20, 0.2);
            border: 1px solid rgba(229, 9, 20, 0.4);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 20px;
            color: #ff6b6b;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: shake 0.5s ease;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20%,
            60% {
                transform: translateX(-5px);
            }

            40%,
            80% {
                transform: translateX(5px);
            }
        }

        .password-remember {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            margin-bottom: 25px;
            cursor: pointer;
        }

        .password-remember input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #e50914;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!-- Initial Loading Screen (Buffer) -->
    <div id="app-loader" class="app-loader">
        <div class="loader-logo" style="display: flex; align-items: center; justify-content: center;"><img
                src="icon.png" style="height: 42px; margin-right: 8px; border-radius: 10px;">è§†ç•Œ
            <span style="font-size:1.2rem; -webkit-text-fill-color: #fff; opacity:0.8;">MAX</span>
        </div>
        <div class="loader-spinner"></div>
    </div>

    <!-- Password Protection Screen -->
    <div id="password-screen" class="password-screen" style="display: none;">
        <div class="password-container">
            <div class="password-logo">
                <div class="password-logo-text" style="display: flex; align-items: center; justify-content: center;">
                    <img src="icon.png" style="height: 32px; margin-right: 8px; border-radius: 8px;">è§†ç•Œ <span
                        style="font-size:1rem; -webkit-text-fill-color: #fff; opacity:0.8;">MAX</span>
                </div>
                <div class="password-logo-subtitle"><i class="fas fa-lock"></i> éœ€è¦å¯†ç æ‰èƒ½è®¿é—®</div>
            </div>

            <div id="password-error" class="password-error" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <span id="password-error-text">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</span>
            </div>

            <form id="password-form" onsubmit="return handlePasswordSubmit(event);">
                <div class="password-input-group">
                    <input type="password" id="password-input" class="password-input" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç "
                        autocomplete="current-password" required>
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">
                        <i id="password-eye" class="fas fa-eye"></i>
                    </button>
                </div>

                <label class="password-remember">
                    <input type="checkbox" id="remember-password" checked>
                    <span>è®°ä½ç™»å½•çŠ¶æ€ (1å¹´)</span>
                </label>

                <button type="submit" class="password-submit" id="password-submit-btn">
                    <i class="fas fa-unlock"></i>
                    <span>éªŒè¯å¯†ç </span>
                </button>
            </form>
        </div>
    </div>

    <div id="app" v-cloak>

        <nav class="navbar-custom" :class="{ 'scrolled': scrollY > 50 }" v-show="!searched">
            <div class="brand" @click="goHome" style="cursor: pointer; display: flex; align-items: center;"><img
                    src="icon.png" style="height: 28px; margin-right: 6px; border-radius: 6px;">è§†ç•Œ <span
                    style="font-size:12px; color:#666; font-weight:normal; margin-left: 2px;">MAX</span></div>
        </nav>

        <!-- Back to Top Button -->
        <button class="btn-top" :class="{ show: scrollY > 500 }" @click="scrollToTop">
            <i class="fas fa-arrow-up"></i>
        </button>

        <!-- 1. Hero Carousel -->
        <div id="heroCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="6000"
            v-if="!searched">
            <div class="carousel-inner" v-if="heroList.length > 0">
                <div class="carousel-item" v-for="(item, index) in heroList" :key="index"
                    :class="{ active: index === 0 }">
                    <div class="hero-bg" :style="{ backgroundImage: 'url(' + item.backdrop + ')' }"></div>
                    <div class="hero-overlay">
                        <div class="hero-content">
                            <div class="hero-tag">æœ¬å‘¨ TOP {{ index + 1 }}</div>
                            <h1 class="hero-title">{{ item.title }}</h1>
                            <p class="hero-desc">{{ item.overview }}</p>
                            <div class="hero-btns" style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <button class="btn-play" @click="autoSearch(item.title)"><i class="fas fa-play"></i>
                                    æ’­æ”¾</button>
                                <button class="btn-info" @click="showMovieInfo(item.rawData)"><i
                                        class="fas fa-info-circle"></i> æ›´å¤šä¿¡æ¯</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Search -->
        <div class="search-section"
            :style="{ marginTop: searched ? '60px' : '-35px', position: searched ? 'relative' : 'sticky' }">
            <div class="search-box-wrapper" :class="{ 'compact': !searched && scrollY > 400 }">
                <i class="fas fa-search search-icon" @click="doSearch"></i>
                <input type="text" v-model="keyword" @keyup.enter="doSearch" @input="debouncedSearch"
                    class="search-input" placeholder="è¾“å…¥ç‰‡åæˆ–å‰§é›†åç§°...">
            </div>
        </div>

        <div v-if="!searched">
            <!-- ğŸ• è§‚çœ‹å†å² (æœ€ä¸Šæ–¹) -->
            <div class="section-container animate__animated animate__fadeInUp" v-if="watchHistory.length > 0"
                style="margin-top: 60px; margin-bottom: 10px;">
                <div class="section-header" style="display: flex; align-items: center;">
                    <div class="section-line" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                    <div class="section-title"><i class="fas fa-history"></i> ç»§ç»­è§‚çœ‹</div>
                    <span class="expand-toggle" @click="clearWatchHistory"
                        style="margin-left: auto; color: #888; font-size: 12px;">
                        <i class="fas fa-trash-alt"></i> æ¸…é™¤å…¨éƒ¨
                    </span>
                </div>

                <!-- æ¨ªå‘æ»šåŠ¨ -->
                <div class="scroll-container">
                    <button class="scroll-btn left" v-show="historyCanScrollLeft" @click="scrollHistoryRow(-1)"><i
                            class="fas fa-chevron-left"></i></button>
                    <div class="hot-row" ref="watchHistoryRow" @scroll="onHistoryScroll">
                        <div class="history-card" v-for="(item, index) in watchHistory" :key="item.name + index">
                            <!-- åˆ é™¤æŒ‰é’® (æ”¾åœ¨ card å¤–å±‚é¿å…éšç¼©æ”¾ç§»åŠ¨) -->
                            <div class="history-delete-btn" @click.stop="removeFromHistory(index)">
                                <i class="fas fa-times"></i>
                            </div>
                            <div class="poster-wrap" @click="playFromHistory(item)">
                                <img :src="item.poster" :alt="item.name"
                                    @error="$event.target.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27150%27 height=%27225%27%3E%3Crect fill=%27%23333%27 width=%27150%27 height=%27225%27/%3E%3C/svg%3E'"
                                    loading="lazy">
                                <!-- è¿›åº¦æ¡ -->
                                <div
                                    style="position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background: rgba(0,0,0,0.5);">
                                    <div
                                        :style="{ width: item.progress + '%', height: '100%', background: 'linear-gradient(90deg, #e50914, #ff4757)' }">
                                    </div>
                                </div>
                                <!-- é›†æ•°æ ‡ç­¾ -->
                                <div v-if="item.episode"
                                    style="position: absolute; top: 6px; left: 6px; background: rgba(0,0,0,0.8); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px;">
                                    {{ item.episode }}
                                </div>
                                <!-- æ’­æ”¾å›¾æ ‡ -->
                                <div class="play-icon-overlay">
                                    <i class="fas fa-play"></i>
                                </div>
                            </div>
                            <div class="movie-name" @click="playFromHistory(item)">{{ item.name }}</div>
                            <div class="movie-date" style="font-size: 11px;">{{ formatWatchTime(item.watchedAt) }}</div>
                        </div>
                    </div>
                    <button class="scroll-btn right" v-show="historyCanScrollRight" @click="scrollHistoryRow(1)"><i
                            class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <!-- åˆ†ç±»å¯¼èˆªæ  -->
            <div class="category-nav-container animate__animated animate__fadeInUp" style="margin-bottom: 40px;">
                <div class="category-item" v-for="item in categories" :key="item.name" @click="handleCatClick(item)">
                    <div class="cat-icon" :style="{ background: item.color }">
                        <i :class="['fas', item.icon]"></i>
                    </div>
                    <span>{{ item.name }}</span>
                </div>
            </div>
            <!-- åŠ¨æ€ç”Ÿæˆçš„æ¦œå• Rows -->
            <div class="section-container animate__animated animate__fadeInUp"
                v-for="(config, key, index) in rowConfigs" :key="key" :ref="key + '-section'" :data-row-key="key">
                <!-- æ ‡é¢˜åŒºï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œç”¨äºæ‡’åŠ è½½è§¦å‘ï¼‰ -->
                <div class="section-header" style="display: flex; align-items: center;">
                    <div class="section-line"></div>
                    <div class="section-title"><i :class="['fas', config.icon]"></i> {{ config.title }}</div>
                    <span class="expand-toggle" :class="{ expanded: expandedRows[key] }" @click="toggleRowExpand(key)"
                        v-show="rowLists[key] && rowLists[key].length > 0">
                        {{ expandedRows[key] ? 'æ”¶èµ·' : 'å±•å¼€' }}
                        <i class="fas fa-chevron-down"></i>
                    </span>
                    <!-- åŠ è½½ä¸­æç¤º -->
                    <span v-if="!rowLists[key]" style="margin-left: 15px; color: #666; font-size: 12px;">
                        <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                    </span>
                </div>
                <!-- å†…å®¹åŒºï¼ˆæœ‰æ•°æ®æ—¶æ˜¾ç¤ºï¼‰ -->
                <template v-if="rowLists[key] && rowLists[key].length > 0">
                    <!-- æ”¶èµ·çŠ¶æ€ï¼šæ¨ªå‘æ»šåŠ¨ -->
                    <div class="scroll-container" v-show="!expandedRows[key]">
                        <button class="scroll-btn left" @click="scrollRow(key, -1)" v-show="rowLeftButtons[key]"><i
                                class="fas fa-chevron-left"></i></button>
                        <div class="hot-row" :ref="key" @scroll="onRowScroll(key)">
                            <div class="hot-card" v-for="item in rowLists[key]" :key="item.id"
                                @click="autoSearch(item.title || item.name)">
                                <div class="poster-wrap">
                                    <img :src="getPosterUrl(item.poster_path)" loading="lazy">
                                    <div class="rating-badge"><i class="fas fa-star text-warning"></i> {{
                                        item.vote_average
                                        ? item.vote_average.toFixed(1) : 'N/A' }}</div>
                                </div>
                                <div class="movie-name">{{ item.title || item.name }}</div>
                                <div class="movie-date">{{ (item.release_date || item.first_air_date ||
                                    '').split('-')[0] }}
                                </div>
                            </div>
                        </div>
                        <button class="scroll-btn right" @click="scrollRow(key, 1)"><i
                                class="fas fa-chevron-right"></i></button>
                    </div>
                    <!-- å±•å¼€çŠ¶æ€ï¼šåˆ†é¡µç½‘æ ¼å¸ƒå±€ -->
                    <div class="grid-expanded" v-show="expandedRows[key]">
                        <div class="hot-card" v-for="item in getPagedItems(key)" :key="'grid-' + item.id"
                            @click="autoSearch(item.title || item.name)">
                            <div class="poster-wrap">
                                <img :src="getPosterUrl(item.poster_path)">
                                <div class="rating-badge"><i class="fas fa-star text-warning"></i> {{ item.vote_average
                                    ? item.vote_average.toFixed(1) : 'N/A' }}</div>
                            </div>
                            <div class="movie-name">{{ item.title || item.name }}</div>
                            <div class="movie-date">{{ (item.release_date || item.first_air_date || '').split('-')[0] }}
                            </div>
                        </div>
                        <!-- åˆ†é¡µæ§åˆ¶åŒº -->
                        <div class="pagination-controls">
                            <button class="page-btn" @click="changeViewPage(key, -1)"
                                :disabled="(viewPages[key] || 1) <= 1">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="page-info">
                                <span class="page-num">{{ viewPages[key] || 1 }}</span> é¡µ
                            </div>
                            <button class="page-btn" @click="changeViewPage(key, 1)"
                                :disabled="(viewPages[key] || 1) >= getTotalViewPages(key) && rowConfigs[key].page >= (rowConfigs[key].totalPages || 999)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Search Results -->
        <div id="search-result-anchor" class="section-container" v-if="searched">
            <div class="d-flex align-items-center gap-2 mb-5 mt-2">
                <button class="btn btn-outline-secondary rounded-pill px-3 px-md-4 py-2" @click="goHome"
                    style="color: #fff; border-color: rgba(255,255,255,0.3);">
                    <i class="fas fa-arrow-left me-0 me-md-2"></i><span class="d-none d-md-inline">è¿”å›é¦–é¡µ</span>
                </button>
                <div class="section-header mb-0 ms-3 ms-md-4">
                    <div class="section-line"></div>
                    <div class="section-title">æ­£åœ¨æœç´¢: "{{ keyword }}"</div>
                </div>
            </div>

            <!-- æœç´¢ç»“æœç½‘æ ¼ (å³ä½¿åœ¨ loading ä¹Ÿå¯ä»¥æ˜¾ç¤º) -->
            <div class="result-grid" v-if="groupedList.length > 0">
                <div class="result-card" v-for="group in groupedList" :key="group.name" @click="openDetail(group)">
                    <div class="poster-wrap">
                        <img v-if="!isFallback(group.name)" :src="finalPoster(group)" :key="finalPoster(group)"
                            referrerpolicy="no-referrer" @error="handleImgError(group.name)" loading="lazy">
                        <div v-else class="poster-fallback">
                            <i class="fas fa-film mb-2 opacity-50"></i>
                            <div style="font-size:12px; color:#999">{{ group.name }}</div>
                        </div>
                        <div class="rating-badge" style="background:var(--accent); color:#fff; border:none;">
                            {{ group.sources.length }} æº
                        </div>
                    </div>
                    <div class="movie-name">{{ group.name }}</div>
                </div>
            </div>

            <!-- åŠ è½½ä¸­æç¤º (å¦‚æœæ²¡ç»“æœå±…ä¸­ï¼Œæœ‰ç»“æœåœ¨åº•éƒ¨) -->
            <div v-if="loading" class="text-center py-4">
                <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-2 text-muted small" v-if="groupedList.length > 0">æ­£åœ¨æœç´¢æ›´å¤šèµ„æº...</div>
                <div class="mt-2 text-muted small" v-else>æ­£åœ¨å…¨ç½‘æœç´¢...</div>
            </div>

            <div v-if="!loading && groupedList.length === 0" class="text-center"
                style="padding: 60px 20px; margin-top: -20px;">
                <i class="fas fa-search" style="font-size: 48px; color: #444; margin-bottom: 20px;"></i>
                <h4 style="color: #888; margin-bottom: 15px;">æš‚æœªæ‰¾åˆ°ã€Œ{{ keyword }}ã€çš„ç›¸å…³èµ„æº</h4>
                <div style="color: #666; font-size: 14px; line-height: 1.8; max-width: 400px; margin: 0 auto;">
                    <p style="margin-bottom: 8px;">ğŸ“Œ æ–°ä¸Šæ˜ çš„ç”µå½±/å‰§é›†å¯èƒ½éœ€è¦ç­‰å¾…1-2å‘¨æ‰æœ‰èµ„æº</p>
                    <p style="margin-bottom: 8px;">ğŸ’¡ å°è¯•æœç´¢ç”µå½±çš„ä¸­æ–‡å</p>
                    <p>ğŸ” æˆ–å°è¯•æœç´¢å…¶ä»–çƒ­é—¨å½±ç‰‡</p>
                </div>
                <button class="btn btn-outline-danger mt-4" @click="clearSearch"
                    style="border-radius: 20px; padding: 8px 25px;">
                    <i class="fas fa-home"></i> è¿”å›é¦–é¡µ
                </button>
            </div>
        </div>

        <div class="footer">
            <div style="font-size:10px; margin-top:5px; opacity:0.5;">Data provided by TMDb & Maccms APIs</div>
        </div>

        <!-- â˜…â˜…â˜… TMDb ç”µå½±è¯¦æƒ…å¼¹çª— â˜…â˜…â˜… -->
        <div class="info-modal-overlay" v-if="showInfoModal" @click.self="showInfoModal = false">
            <div class="info-modal" v-if="infoModalData">
                <button class="info-modal-close" @click="showInfoModal = false"><i class="fas fa-times"></i></button>
                <div class="info-modal-backdrop"
                    :style="{ backgroundImage: 'url(' + TMDB_BACKDROP_URL + infoModalData.backdrop_path + ')' }"></div>
                <div class="info-modal-content">
                    <div class="info-modal-poster">
                        <img :src="TMDB_IMG_URL + infoModalData.poster_path"
                            :alt="infoModalData.title || infoModalData.name">
                    </div>
                    <div class="info-modal-details">
                        <h2>{{ infoModalData.title || infoModalData.name }}</h2>
                        <div class="info-modal-meta">
                            <span class="info-rating"><i class="fas fa-star text-warning"></i> {{
                                infoModalData.vote_average?.toFixed(1) }}</span>
                            <span>{{ (infoModalData.release_date || infoModalData.first_air_date)?.split('-')[0]
                                }}</span>
                            <span v-if="infoModalData.runtime">{{ infoModalData.runtime }} åˆ†é’Ÿ</span>
                        </div>
                        <p class="info-overview">{{ infoModalData.overview || 'æš‚æ— ç®€ä»‹' }}</p>
                        <div class="info-modal-btns">
                            <button class="btn-play"
                                @click="showInfoModal = false; autoSearch(infoModalData.title || infoModalData.name)">
                                <i class="fas fa-play"></i> ç«‹å³æ’­æ”¾
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- â˜…â˜…â˜… æ’­æ”¾è¯¦æƒ…é¡µ (å½±é™¢å¸ƒå±€) â˜…â˜…â˜… -->
        <div class="detail-overlay" :class="{ active: showDetail }">
            <div class="close-btn" @click="closeDetail"><i class="fas fa-times"></i></div>

            <div class="player-layout" v-if="currentGroup">

                <!-- 1. é¡¶éƒ¨ï¼šæ ‡é¢˜æ  + æŠ•å± -->
                <div class="video-header">
                    <div>
                        <h1 class="video-title">{{ currentGroup.name }}</h1>
                        <div class="video-meta">
                            æ­£åœ¨æ’­æ”¾: <span class="text-white fw-bold">{{ currentSource?.site_name }}</span>
                        </div>
                    </div>
                    <button class="btn-cast" @click="castVideo">
                        <i class="fas fa-tv"></i> ä¸€é”®æŠ•å±
                    </button>
                </div>

                <!-- 2. ä¸­éƒ¨ï¼šè¶…å¤§æ’­æ”¾å™¨ -->
                <div class="player-box" style="position: relative;">
                    <div id="dplayer" style="width: 100%; height: 100%;"></div>
                    <!-- è‡ªåŠ¨åˆ‡æ¢çº¿è·¯æç¤º -->
                    <div v-if="autoRetryMessage" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                               background: rgba(0,0,0,0.9); padding: 20px 30px; border-radius: 10px; 
                               text-align: center; z-index: 100; border: 1px solid rgba(255,255,255,0.1);">
                        <i class="fas fa-sync-alt fa-spin"
                            style="font-size: 24px; color: #e50914; margin-bottom: 10px;"></i>
                        <div style="color: #fff; font-weight: bold;">{{ autoRetryMessage }}</div>
                        <div style="color: #888; font-size: 12px; margin-top: 5px;">æ­£åœ¨è‡ªåŠ¨åˆ‡æ¢...</div>
                    </div>
                </div>

                <!-- 3. åº•éƒ¨ï¼šæ§åˆ¶é¢æ¿ -->
                <div class="controls-area">
                    <!-- å‰§é›†ç®€ä»‹ -->
                    <div class="mb-4" v-if="currentSource">
                        <div class="panel-title">å‰§æƒ…ç®€ä»‹</div>
                        <p
                            style="color: #999; font-size: 13px; line-height: 1.7; max-height: 80px; overflow-y: auto; margin: 0;">
                            <span v-if="loadingDetail"><i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...</span>
                            <span v-else>{{ stripHtml(currentSource.vod_content) || 'æš‚æ— ç®€ä»‹ä¿¡æ¯' }}</span>
                        </p>
                    </div>

                    <!-- çº¿è·¯é€‰æ‹© -->
                    <div class="mb-4">
                        <div class="panel-title">
                            åˆ‡æ¢çº¿è·¯
                            <span v-if="isTestingSources" style="font-size: 12px; color: #888; font-weight: normal;">
                                <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æµ‹é€Ÿ...
                            </span>
                        </div>

                        <!-- æµ‹é€Ÿç±»å‹å›¾ä¾‹ -->
                        <div v-if="!isTestingSources && (fastSources.length > 0 || slowSources.length > 0)"
                            style="font-size: 11px; color: #666; margin-bottom: 10px; display: flex; gap: 15px; align-items: center;">
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <span
                                    style="background: linear-gradient(135deg, #10b981, #059669); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 9px;">ç›´è¿</span>
                                ç”¨æˆ·ç«¯æµ‹é€Ÿï¼ˆæ›´å‡†ç¡®ï¼‰
                            </span>
                            <span style="display: flex; align-items: center; gap: 4px;">
                                <span
                                    style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 9px;">ä»£ç†</span>
                                æœåŠ¡å™¨æµ‹é€Ÿ
                            </span>
                        </div>

                        <!-- å¿«é€Ÿçº¿è·¯åˆ—è¡¨ (< 600ms) -->
                        <div class="source-list" v-if="fastSources.length > 0 || slowSources.length > 0">
                            <!-- å¿«é€Ÿçº¿è·¯ -->
                            <div v-for="source in fastSources" class="source-pill"
                                :class="{ active: currentSource?.site_key === source.site_key }"
                                @click="switchSource(source)">
                                <span>{{ source.site_name }}</span>
                                <span class="latency-dot" :class="getLatencyClass(source.latency)"></span>
                                <span style="font-size:10px; opacity:0.6;">{{source.latency}}ms</span>
                                <span v-if="source._testType === 'direct'"
                                    style="background: linear-gradient(135deg, #10b981, #059669); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 9px; margin-left: 4px;">
                                    ç›´è¿
                                </span>
                                <span v-else
                                    style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 9px; margin-left: 4px;">
                                    ä»£ç†
                                </span>
                            </div>
                            <!-- æ…¢é€Ÿçº¿è·¯åˆ†éš”ç¬¦ -->
                            <div v-if="slowSources.length > 0 && fastSources.length > 0"
                                style="width: 100%; font-size: 11px; color: #666; padding: 8px 0; border-top: 1px solid #333; margin-top: 5px;">
                                <i class="fas fa-hourglass-half"></i> è¾ƒæ…¢çº¿è·¯ ({{ slowSources.length }})
                            </div>
                            <!-- æ…¢é€Ÿçº¿è·¯ -->
                            <div v-for="source in slowSources" class="source-pill"
                                :class="{ active: currentSource?.site_key === source.site_key }" style="opacity: 0.7;"
                                @click="switchSource(source)">
                                <span>{{ source.site_name }}</span>
                                <span class="latency-dot" :class="getLatencyClass(source.latency)"></span>
                                <span style="font-size:10px; opacity:0.6;">{{source.latency}}ms</span>
                                <span v-if="source._testType === 'direct'"
                                    style="background: linear-gradient(135deg, #10b981, #059669); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 9px; margin-left: 4px;">
                                    ç›´è¿
                                </span>
                                <span v-else
                                    style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: #fff; padding: 1px 5px; border-radius: 3px; font-size: 9px; margin-left: 4px;">
                                    ä»£ç†
                                </span>
                            </div>
                        </div>

                        <!-- å…¨éƒ¨ä¸å¯ç”¨æç¤º -->
                        <div v-else-if="!isTestingSources && fastSources.length === 0 && slowSources.length === 0"
                            class="text-center py-4"
                            style="background: rgba(255,0,0,0.1); border-radius: 8px; border: 1px solid rgba(255,0,0,0.2);">
                            <i class="fas fa-exclamation-triangle text-warning" style="font-size: 24px;"></i>
                            <div class="mt-2" style="color: #ff6b6b;">æ‰€æœ‰é‡‡é›†ç«™å‡ä¸å¯ç”¨</div>
                            <div class="mt-1" style="font-size: 12px; color: #888;">è¯·ç¨åé‡è¯•æˆ–å°è¯•æœç´¢å…¶ä»–èµ„æº</div>
                        </div>
                    </div>

                    <!-- é€‰é›†åˆ—è¡¨ (å…¨å®½ç½‘æ ¼) -->
                    <div>
                        <div class="panel-title">é€‰é›†æ’­æ”¾</div>
                        <div v-if="loadingDetail" class="text-center py-5 text-muted"><i
                                class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...</div>
                        <div v-else class="ep-grid">
                            <div v-for="ep in episodeList" class="ep-btn" :class="{ active: currentUrl === ep.url }"
                                @click="play(ep.url)">
                                {{ ep.name }}
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- Password Verification Script (runs before Vue) -->
    <script data-cfasync="false">
        // SHA256 Hash Function (Pure JS implementation)
        // SHA256 Hash Function (No longer used on client-side to avoid browser compat issues)
        // async function sha256(message) {
        //     const msgBuffer = new TextEncoder().encode(message);
        //     const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        //     const hashArray = Array.from(new Uint8Array(hashBuffer));
        //     return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        // }

        // Storage Keys
        const AUTH_STORAGE_KEY = 'emax_auth_hash';
        const AUTH_EXPIRY_KEY = 'emax_auth_expiry';

        // Check if already authenticated
        function isAuthenticated() {
            const storedHash = localStorage.getItem(AUTH_STORAGE_KEY);
            const expiry = localStorage.getItem(AUTH_EXPIRY_KEY);

            if (!storedHash || !expiry) return false;

            // Check if expired
            if (Date.now() > parseInt(expiry)) {
                localStorage.removeItem(AUTH_STORAGE_KEY);
                localStorage.removeItem(AUTH_EXPIRY_KEY);
                return false;
            }

            return storedHash;
        }

        // Toggle password visibility
        function togglePasswordVisibility() {
            const input = document.getElementById('password-input');
            const eye = document.getElementById('password-eye');

            if (input.type === 'password') {
                input.type = 'text';
                eye.classList.remove('fa-eye');
                eye.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                eye.classList.remove('fa-eye-slash');
                eye.classList.add('fa-eye');
            }
        }

        // Show error message
        function showPasswordError(message) {
            const errorDiv = document.getElementById('password-error');
            const errorText = document.getElementById('password-error-text');
            errorText.textContent = message;
            errorDiv.style.display = 'flex';
        }

        // Handle password submit
        async function handlePasswordSubmit(event) {
            event.preventDefault();

            const input = document.getElementById('password-input');
            const submitBtn = document.getElementById('password-submit-btn');
            const remember = document.getElementById('remember-password').checked;
            const errorDiv = document.getElementById('password-error');

            // Hide previous error
            errorDiv.style.display = 'none';

            // Disable button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>éªŒè¯ä¸­...</span>';

            try {
                // Skip client-side hashing to avoid browser compatibility issues
                // const passwordHash = await sha256(input.value);

                // Verify with server (send plain password)
                const res = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: input.value })
                });

                const data = await res.json();

                if (data.success) {
                    // Save auth state (use hash returned from server)
                    if (remember) {
                        const expiry = Date.now() + (365 * 24 * 60 * 60 * 1000); // 365 days
                        // Server returns passwordHash on success
                        localStorage.setItem(AUTH_STORAGE_KEY, data.passwordHash);
                        localStorage.setItem(AUTH_EXPIRY_KEY, expiry.toString());
                    }

                    // Start App and wait for data
                    if (window.startApp) {
                        await window.startApp();
                    }

                    // Hide password screen with animation
                    const screen = document.getElementById('password-screen');
                    screen.classList.add('hidden');

                    setTimeout(() => {
                        screen.style.display = 'none';
                    }, 500);
                } else {
                    showPasswordError('å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•');
                    input.value = '';
                    input.focus();
                }
            } catch (e) {
                showPasswordError('éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                console.error('Auth error:', e);
            }

            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-unlock"></i><span>éªŒè¯å¯†ç </span>';

            return false;
        }

        // Check auth status on page load
        async function checkAuthStatus() {
            try {
                const res = await fetch('/api/auth/check');
                const data = await res.json();

                if (!data.requirePassword) {
                    // No password required, start app directly
                    window.startApp && window.startApp();
                    return;
                }

                // Password required, check if already authenticated
                const storedHash = isAuthenticated();
                if (storedHash) {
                    // Verify stored hash is still valid
                    const verifyRes = await fetch('/api/auth/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ passwordHash: storedHash })
                    });
                    const verifyData = await verifyRes.json();

                    if (verifyData.success) {
                        // Stored auth is valid, start app
                        window.startApp && window.startApp();
                        return;
                    } else {
                        // Stored auth is invalid, clear it
                        localStorage.removeItem(AUTH_STORAGE_KEY);
                        localStorage.removeItem(AUTH_EXPIRY_KEY);
                    }
                }

                // Show password screen
                const loader = document.getElementById('app-loader');
                const screen = document.getElementById('password-screen');

                // Hide loader, show password screen
                if (loader) loader.classList.add('hidden');
                screen.style.display = 'flex';

                // Focus input
                setTimeout(() => {
                    document.getElementById('password-input').focus();
                }, 100);

            } catch (e) {
                console.error('Auth check error:', e);
                // On error, try to start app anyway
                window.startApp && window.startApp();
            }
        }

        // Run check when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
        });
    </script>

    <script data-cfasync="false">
        const { createApp, reactive } = Vue;
        // TMDb API é…ç½® (ä»æœåŠ¡ç«¯è·å–)
        let TMDB_API_KEY = "";

        // TMDb URL é…ç½® (ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨ç¼“å­˜åä»£)
        let TMDB_BASE_URL = "https://api.themoviedb.org/3";
        // ä½¿ç”¨æœ¬åœ° API ç¼“å­˜å›¾ç‰‡
        let TMDB_IMG_URL = "/api/tmdb-image/w342";
        let TMDB_BACKDROP_URL = "/api/tmdb-image/original";

        // TMDB åä»£é…ç½®ç°åœ¨é€šè¿‡ç¯å¢ƒå˜é‡ TMDB_PROXY_URL é…ç½®
        // è¯¦è§ .env.example å’Œ cloudflare-tmdb-proxy.js

        let dp = null;

        createApp({
            data() {
                return {
                    searchTimer: null,  // é˜²æŠ–æœç´¢å®šæ—¶å™¨
                    isTestingSources: false,  // æ­£åœ¨æµ‹é€ŸçŠ¶æ€
                    showInfoModal: false,  // ç”µå½±è¯¦æƒ…å¼¹çª—
                    infoModalData: null,   // å¼¹çª—æ•°æ®
                    TMDB_IMG_URL: TMDB_IMG_URL,  // æ¨¡æ¿ä¸­ä½¿ç”¨
                    TMDB_BACKDROP_URL: TMDB_BACKDROP_URL,

                    // æ¢å¤ç¼ºå¤±çš„çŠ¶æ€å˜é‡
                    keyword: '', loading: false, searched: false, rawList: [],
                    showDetail: false, currentGroup: null, currentSource: null,
                    episodeList: [], currentUrl: '', loadingDetail: false,
                    imageMap: {}, fallbackMap: {}, heroList: [], scrollY: 0,
                    hotList: [],
                    sitesMap: {},  // ç¼“å­˜ç«™ç‚¹ä¿¡æ¯ï¼ˆç”¨äºå®¢æˆ·ç«¯æµ‹é€Ÿï¼‰
                    playbackErrorCount: 0,  // æ’­æ”¾å¤±è´¥è®¡æ•°
                    isAutoRetrying: false,  // æ˜¯å¦æ­£åœ¨è‡ªåŠ¨é‡è¯•
                    autoRetryMessage: '',  // è‡ªåŠ¨åˆ‡æ¢æç¤ºä¿¡æ¯
                    watchHistory: [],  // ç”¨æˆ·è§‚çœ‹å†å²è®°å½•
                    historyExpanded: false,  // è§‚çœ‹å†å²å±•å¼€çŠ¶æ€
                    historyCanScrollLeft: false,  // å¯ä»¥å‘å·¦æ»šåŠ¨
                    historyCanScrollRight: false,  // å¯ä»¥å‘å³æ»šåŠ¨
                    rowLeftButtons: {}, // å­˜å‚¨å„åˆ†ç±»æ¦œå•å·¦ä¾§æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€ { movieRow: false, ... }

                    // === åŠ¨æ€æ¦œå•é…ç½® ===
                    rowLists: {}, // å­˜å‚¨å„æ¦œå•æ•°æ® { movieRow: [...], ... }
                    expandedRows: {}, // å­˜å‚¨å„æ¦œå•çš„å±•å¼€çŠ¶æ€ { movieRow: true, ... }
                    viewPages: {}, // å­˜å‚¨å„æ¦œå•å±•å¼€æ—¶çš„æŸ¥çœ‹é¡µç  { movieRow: 1, ... }
                    pageLoadingKeys: {}, // é˜²æ­¢é‡å¤å¿«é€Ÿç‚¹å‡»åŠ è½½ { movieRow: true, ... }
                    rowConfigs: {
                        movieRow: { title: 'å…¨çƒéœ‡æ„ŸÂ·ç”µå½±æ¦œ', icon: 'fa-film', path: '/trending/movie/week', params: '', page: 1 },
                        tvRow: { title: 'å…¨çƒå¿…è¿½Â·å‰§é›†æ¦œ', icon: 'fa-tv', path: '/trending/tv/week', params: '', page: 1 },
                        cnRow: { title: 'åè¯­å¼ºæ¡£Â·å›½äº§å‰§', icon: 'fa-dragon', path: '/discover/tv', params: 'with_origin_country=CN&sort_by=popularity.desc', page: 1 },
                        usRow: { title: 'ç¾å‰§Â·é«˜èƒ½å‰§é›†', icon: 'fa-flag-usa', path: '/discover/tv', params: 'with_origin_country=US&sort_by=popularity.desc', page: 1 },
                        krjpRow: { title: 'æ—¥éŸ©æ½®æµÂ·å‰§é›†', icon: 'fa-mask', path: '/discover/tv', params: 'with_origin_country=KR|JP&sort_by=popularity.desc', page: 1 },
                        animeRow: { title: 'äºŒæ¬¡å…ƒÂ·åŠ¨æ¼«ç•ªå‰§', icon: 'fa-ghost', path: '/discover/tv', params: 'with_genres=16&sort_by=popularity.desc', page: 1 },
                        scifiRow: { title: 'ç§‘å¹»å¥‡å¹»Â·æ˜Ÿé™…ç©¿è¶Š', icon: 'fa-rocket', path: '/discover/movie', params: 'with_genres=878,14&sort_by=popularity.desc', page: 1 },
                        actionRow: { title: 'åŠ¨ä½œå¤§ç‰‡Â·è‚¾ä¸Šè…ºç´ ', icon: 'fa-bomb', path: '/discover/movie', params: 'with_genres=28&sort_by=popularity.desc', page: 1 },
                        comedyRow: { title: 'å¼€å¿ƒå–œå‰§Â·è§£å‹å¿…å¤‡', icon: 'fa-laugh-squint', path: '/discover/movie', params: 'with_genres=35&sort_by=popularity.desc', page: 1 },
                        crimeRow: { title: 'çŠ¯ç½ªæ‚¬ç–‘Â·çƒ§è„‘ç¥ä½œ', icon: 'fa-user-secret', path: '/discover/movie', params: 'with_genres=80,9648&sort_by=popularity.desc', page: 1 },
                        romanceRow: { title: 'çˆ±æƒ…Â·æµªæ¼«æ»¡å±‹', icon: 'fa-heart', path: '/discover/movie', params: 'with_genres=10749&sort_by=popularity.desc', page: 1 },
                        familyRow: { title: 'åˆå®¶æ¬¢Â·æ¸©é¦¨æ—¶åˆ»', icon: 'fa-home', path: '/discover/movie', params: 'with_genres=10751&sort_by=popularity.desc', page: 1 },
                        docRow: { title: 'çºªå½•ç‰‡Â·æ¢ç´¢ä¸–ç•Œ', icon: 'fa-video', path: '/discover/movie', params: 'with_genres=99&sort_by=popularity.desc', page: 1 },
                        warRow: { title: 'æˆ˜äº‰Â·å²è¯—å·¨åˆ¶', icon: 'fa-fighter-jet', path: '/discover/movie', params: 'with_genres=10752&sort_by=popularity.desc', page: 1 },
                        horrorRow: { title: 'ææ€–æƒŠæ‚šÂ·èƒ†å°å‹¿å…¥', icon: 'fa-skull', path: '/discover/movie', params: 'with_genres=27&sort_by=popularity.desc', page: 1 },
                        mysteryRow: { title: 'çƒ§è„‘æ‚¬ç–‘Â·å±‚å±‚åè½¬', icon: 'fa-search', path: '/discover/movie', params: 'with_genres=9648&sort_by=popularity.desc', page: 1 },
                        fantasyRow: { title: 'å¥‡å¹»å†’é™©Â·å¼‚æƒ³å¤©å¼€', icon: 'fa-hat-wizard', path: '/discover/movie', params: 'with_genres=14&sort_by=popularity.desc', page: 1 },
                        varietyRow: { title: 'çƒ­é—¨ç»¼è‰ºÂ·å¨±ä¹ç”Ÿæ´»', icon: 'fa-microphone-alt', path: '/discover/tv', params: 'with_genres=10764&sort_by=popularity.desc', page: 1 },
                        historyRow: { title: 'å†å²Â·å²æœˆé•¿æ²³', icon: 'fa-landmark', path: '/discover/movie', params: 'with_genres=36&sort_by=popularity.desc', page: 1 },
                        adventureRow: { title: 'æƒŠé™©å†’é™©Â·å‹‡æ•¢è€…æ¸¸æˆ', icon: 'fa-compass', path: '/discover/movie', params: 'with_genres=12&sort_by=popularity.desc', page: 1 },
                    },

                    movieList: [], tvList: [], list_cn: [], list_krjp: [],
                    list_scifi: [], list_action: [], list_comedy: [], list_horror: [],
                    categories: [
                        { name: 'ç”µå½±', icon: 'fa-film', action: 'scroll', value: 'movieRow', color: 'linear-gradient(135deg, #FF512F 0%, #DD2476 100%)' },
                        { name: 'å‰§é›†', icon: 'fa-tv', action: 'scroll', value: 'tvRow', color: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
                        { name: 'å›½äº§', icon: 'fa-dragon', action: 'scroll', value: 'cnRow', color: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
                        { name: 'ç¾å‰§', icon: 'fa-flag-usa', action: 'scroll', value: 'usRow', color: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)' },
                        { name: 'æ—¥éŸ©', icon: 'fa-mask', action: 'scroll', value: 'krjpRow', color: 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)' },
                        { name: 'åŠ¨æ¼«', icon: 'fa-ghost', action: 'scroll', value: 'animeRow', color: 'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)' },
                        { name: 'åŠ¨ä½œ', icon: 'fa-bomb', action: 'scroll', value: 'actionRow', color: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)' },
                        { name: 'ç§‘å¹»', icon: 'fa-rocket', action: 'scroll', value: 'scifiRow', color: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' },
                        { name: 'å–œå‰§', icon: 'fa-laugh-squint', action: 'scroll', value: 'comedyRow', color: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)' },
                        { name: 'çŠ¯ç½ª', icon: 'fa-user-secret', action: 'scroll', value: 'crimeRow', color: 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)' },
                        { name: 'çˆ±æƒ…', icon: 'fa-heart', action: 'scroll', value: 'romanceRow', color: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)' },
                        { name: 'æ‚¬ç–‘', icon: 'fa-search', action: 'scroll', value: 'mysteryRow', color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                        { name: 'å†å²', icon: 'fa-landmark', action: 'scroll', value: 'historyRow', color: 'linear-gradient(135deg, #accbee 0%, #e7f0fd 100%)' },
                        { name: 'å®¶åº­', icon: 'fa-home', action: 'scroll', value: 'familyRow', color: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)' },
                        { name: 'çºªå½•', icon: 'fa-video', action: 'scroll', value: 'docRow', color: 'linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%)' },
                        { name: 'æˆ˜äº‰', icon: 'fa-fighter-jet', action: 'scroll', value: 'warRow', color: 'linear-gradient(135deg, #ff0844 0%, #ffb199 100%)' },
                        { name: 'å†’é™©', icon: 'fa-compass', action: 'scroll', value: 'adventureRow', color: 'linear-gradient(135deg, #e9defa 0%, #fbfcdb 100%)' },
                        { name: 'ç»¼è‰º', icon: 'fa-microphone-alt', action: 'scroll', value: 'varietyRow', color: 'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)' },
                        { name: 'ææ€–', icon: 'fa-skull', action: 'scroll', value: 'horrorRow', color: 'linear-gradient(135deg, #434343 0%, #000000 100%)' },
                        { name: 'å¥‡å¹»', icon: 'fa-hat-wizard', action: 'scroll', value: 'fantasyRow', color: 'linear-gradient(135deg, #fccb90 0%, #d57eeb 100%)' }
                    ]
                }
            },
            async mounted() {
                window.addEventListener('scroll', () => { this.scrollY = window.scrollY; });

                // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œæ›´æ–°å†å²æ»šåŠ¨æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
                window.addEventListener('resize', () => { this.updateHistoryScrollNeeded(); });

                // Store reference to app instance for external access
                window.vueApp = this;

                // å®šä¹‰ startApp å‡½æ•°ä¾›å¯†ç éªŒè¯æˆåŠŸåè°ƒç”¨
                window.startApp = () => {
                    return this.initApp();
                };
            },
            computed: {
                groupedList() {
                    const groups = {};
                    this.rawList.forEach(item => {
                        const name = item.vod_name;
                        if (!groups[name]) groups[name] = { name: name, pic: item.vod_pic, sources: [] };
                        const isDefault = (url) => !url || url.includes('mac_default') || url.includes('nopic');
                        if (isDefault(groups[name].pic) && !isDefault(item.vod_pic)) groups[name].pic = item.vod_pic;
                        if (isDefault(groups[name].pic)) this.handleImgError(name);

                        groups[name].sources.push({
                            ...item,
                            latency: item.latency || 999
                        });
                    });
                    return Object.values(groups).sort((a, b) => b.sources.length - a.sources.length);
                },
                // å¿«é€Ÿçº¿è·¯ (å»¶è¿Ÿ < 600ms)
                fastSources() {
                    if (!this.currentGroup || !this.currentGroup.sources) return [];
                    return this.currentGroup.sources.filter(s => {
                        if (s.latency === '...') return false;
                        return typeof s.latency === 'number' && s.latency < 600;
                    });
                },
                // æ…¢é€Ÿçº¿è·¯ (600ms <= å»¶è¿Ÿ < 9000msï¼Œéè¶…æ—¶)
                slowSources() {
                    if (!this.currentGroup || !this.currentGroup.sources) return [];
                    return this.currentGroup.sources.filter(s => {
                        if (s.latency === '...') return false;
                        return typeof s.latency === 'number' && s.latency >= 600 && s.latency < 9000;
                    });
                },
                // å…¼å®¹æ—§ä»£ç çš„ availableSourcesï¼ˆåŒ…å«å¿«é€Ÿå’Œæ…¢é€Ÿï¼‰
                availableSources() {
                    return [...this.fastSources, ...this.slowSources];
                }
            },
            methods: {
                async initApp() {
                    // é˜²æ­¢é‡å¤åˆå§‹åŒ–
                    if (this._appInitialized) return;
                    this._appInitialized = true;

                    // 1. è·å–åç«¯é…ç½®
                    try {
                        const res = await fetch('/api/config');
                        const config = await res.json();
                        TMDB_API_KEY = config.tmdb_api_key;

                        // Vercel å…¼å®¹æ€§æ£€æµ‹
                        if (config.enable_local_image_cache === false) {
                            console.log('[Config] Vercel ç¯å¢ƒæ£€æµ‹ï¼šç¦ç”¨æœ¬åœ°å›¾ç‰‡ç¼“å­˜ï¼Œä½¿ç”¨å®˜æ–¹æº');
                            // å›é€€åˆ°å®˜æ–¹ CDN
                            this.TMDB_IMG_URL = "https://image.tmdb.org/t/p/w342";
                            this.TMDB_BACKDROP_URL = "https://image.tmdb.org/t/p/original";
                        }

                        // å¦‚æœé…ç½®äº†åä»£åœ°å€ï¼Œè¿›è¡Œ IP æ£€æµ‹å¹¶åˆ‡æ¢
                        if (config.tmdb_proxy_url) {
                            await this.setupTmdbProxy(config.tmdb_proxy_url);
                        }
                    } catch (e) {
                        console.error('Config Load Error:', e);
                    }

                    // 2. å¦‚æœè·å–åˆ°äº† Keyï¼ŒåŠ è½½æ•°æ®
                    if (TMDB_API_KEY) {
                        await this.fetchHero();
                        this.fetchAllLists();
                    } else {
                        console.warn('TMDB_API_KEY æœªé…ç½®');
                    }

                    // 3. ç§»é™¤ Loading é®ç½© (å¹³æ»‘è¿‡æ¸¡)
                    setTimeout(() => {
                        const loader = document.getElementById('app-loader');
                        if (loader) loader.classList.add('hidden');
                    }, 300);

                    // 4. åŠ è½½ç«™ç‚¹ä¿¡æ¯ï¼ˆç”¨äºå®¢æˆ·ç«¯æµ‹é€Ÿï¼‰
                    try {
                        const sitesRes = await fetch('/api/sites');
                        const sitesData = await sitesRes.json();
                        if (sitesData.sites) {
                            sitesData.sites.forEach(site => {
                                this.sitesMap[site.key] = site;
                            });
                        }
                    } catch (e) {
                        console.error('Sites Load Error:', e);
                    }

                    // 5. åŠ è½½è§‚çœ‹å†å²
                    this.loadWatchHistory();
                },

                // ========== ğŸ“º è§‚çœ‹å†å²åŠŸèƒ½ ==========
                // åŠ è½½è§‚çœ‹å†å²
                loadWatchHistory() {
                    try {
                        const saved = localStorage.getItem('donggua_watch_history');
                        if (saved) {
                            const history = JSON.parse(saved);
                            // è¿‡æ»¤æ‰è¶…è¿‡30å¤©çš„è®°å½•
                            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                            this.watchHistory = history.filter(item =>
                                new Date(item.watchedAt).getTime() > thirtyDaysAgo
                            );
                            // å¦‚æœæœ‰è¿‡æ»¤ï¼Œæ›´æ–°å­˜å‚¨
                            if (this.watchHistory.length !== history.length) {
                                this.saveWatchHistoryToStorage();
                            }
                            console.log('[è§‚çœ‹å†å²] å·²åŠ è½½', this.watchHistory.length, 'æ¡è®°å½•');
                            this.$nextTick(() => this.updateHistoryScrollNeeded());
                        }
                    } catch (e) {
                        console.error('[è§‚çœ‹å†å²] åŠ è½½å¤±è´¥:', e);
                    }
                },

                // ä¿å­˜è§‚çœ‹å†å²åˆ° localStorage
                saveWatchHistoryToStorage() {
                    try {
                        localStorage.setItem('donggua_watch_history', JSON.stringify(this.watchHistory));
                    } catch (e) {
                        console.error('[è§‚çœ‹å†å²] ä¿å­˜å¤±è´¥:', e);
                    }
                },

                // æ·»åŠ åˆ°è§‚çœ‹å†å²ï¼ˆåŒ…å« groupData ç”¨äºç›´æ¥æ’­æ”¾ï¼‰
                addToWatchHistory(name, poster, episode, progress, duration, groupData) {
                    // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨
                    const existingIndex = this.watchHistory.findIndex(item => item.name === name);

                    const historyItem = {
                        name: name,
                        poster: poster || '',
                        episode: episode || null,  // å½“å‰é›†æ•°ï¼Œå¦‚ "ç¬¬5é›†"
                        progress: duration > 0 ? Math.min(Math.round((progress / duration) * 100), 100) : 0,
                        watchedAt: new Date().toISOString(),
                        // ä¿å­˜æ’­æ”¾æ‰€éœ€çš„æ•°æ®ï¼ˆç”¨äºç›´æ¥æ’­æ”¾ï¼‰
                        groupData: groupData ? {
                            name: groupData.name,
                            pic: groupData.pic,
                            sources: groupData.sources.map((s, idx) => ({
                                vod_name: s.vod_name,
                                vod_pic: s.vod_pic,
                                vod_play_url: s.vod_play_url,
                                vod_content: s.vod_content || '',  // å‰§æƒ…ä»‹ç»
                                site_name: s.site_name,
                                site_key: s.site_key || (s.site_name + '_' + idx),  // ç”¨äºåŒ¹é…é«˜äº®
                                latency: s.latency || 500  // é»˜è®¤å»¶è¿Ÿ
                            }))
                        } : null
                    };

                    if (existingIndex !== -1) {
                        // æ›´æ–°å·²å­˜åœ¨çš„è®°å½•
                        this.watchHistory.splice(existingIndex, 1);
                    }

                    // æ·»åŠ åˆ°æœ€å‰é¢
                    this.watchHistory.unshift(historyItem);

                    // é™åˆ¶æœ€å¤šä¿å­˜30æ¡
                    if (this.watchHistory.length > 30) {
                        this.watchHistory = this.watchHistory.slice(0, 30);
                    }

                    this.saveWatchHistoryToStorage();
                    console.log('[è§‚çœ‹å†å²] å·²ä¿å­˜:', name, 'è¿›åº¦:', historyItem.progress + '%', 'groupData:', !!groupData);
                },

                // æ¸…é™¤è§‚çœ‹å†å²
                clearWatchHistory() {
                    if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è§‚çœ‹å†å²å—ï¼Ÿ')) {
                        this.watchHistory = [];
                        localStorage.removeItem('donggua_watch_history');
                        console.log('[è§‚çœ‹å†å²] å·²æ¸…é™¤');
                    }
                },

                // æ ¼å¼åŒ–è§‚çœ‹æ—¶é—´
                formatWatchTime(isoString) {
                    if (!isoString) return '';
                    const date = new Date(isoString);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / (60 * 1000));
                    const diffHours = Math.floor(diffMs / (60 * 60 * 1000));
                    const diffDays = Math.floor(diffMs / (24 * 60 * 60 * 1000));

                    if (diffMins < 1) return 'åˆšåˆš';
                    if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
                    if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
                    if (diffDays < 7) return `${diffDays}å¤©å‰`;
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                },

                // ä»å†å²è®°å½•ä¸­åˆ é™¤å•ä¸ªé¡¹ç›®
                removeFromHistory(index) {
                    if (index >= 0 && index < this.watchHistory.length) {
                        const removed = this.watchHistory.splice(index, 1);
                        this.saveWatchHistoryToStorage();
                        this.$nextTick(() => this.updateHistoryScrollNeeded());
                        console.log('[è§‚çœ‹å†å²] å·²åˆ é™¤:', removed[0]?.name);
                    }
                },

                // ä»å†å²è®°å½•ç›´æ¥æ’­æ”¾
                async playFromHistory(item) {
                    if (!item || !item.name) return;
                    console.log('[è§‚çœ‹å†å²] ç‚¹å‡»æ’­æ”¾:', item.name, 'groupData:', !!item.groupData, 'episode:', item.episode);

                    // å¦‚æœæœ‰ä¿å­˜çš„ groupDataï¼Œç›´æ¥æ’­æ”¾
                    if (item.groupData && item.groupData.sources && item.groupData.sources.length > 0) {
                        console.log('[è§‚çœ‹å†å²] ä½¿ç”¨ä¿å­˜çš„æ•°æ®ç›´æ¥æ’­æ”¾');

                        // ç¡®ä¿æ‰€æœ‰ sources æœ‰ site_key
                        const sourcesWithKey = item.groupData.sources.map((s, idx) => ({
                            ...s,
                            site_key: s.site_key || (s.site_name + '_' + idx),
                            latency: s.latency || 500
                        }));

                        // è®¾ç½® currentGroupï¼ˆç¡®ä¿ sources æœ‰æ­£ç¡®çš„ site_keyï¼‰
                        this.currentGroup = {
                            ...item.groupData,
                            sources: sourcesWithKey
                        };

                        // è®¾ç½® rawListï¼ˆç”¨äºæ˜¾ç¤ºèµ„æºç«™åˆ—è¡¨å’Œå…è®¸åˆ‡æ¢ï¼‰
                        this.rawList = sourcesWithKey;

                        // è·å–æœ€ä½³èµ„æº
                        const bestSourceIdx = sourcesWithKey.findIndex(s => s.latency && s.latency < 1000);
                        const bestSource = bestSourceIdx >= 0 ? sourcesWithKey[bestSourceIdx] : sourcesWithKey[0];
                        console.log('[è§‚çœ‹å†å²] é€‰æ‹©èµ„æºç«™:', bestSource?.site_name, 'å»¶è¿Ÿ:', bestSource?.latency);

                        // è®¾ç½® currentSourceï¼ˆä½¿ç”¨ç›¸åŒçš„ site_keyï¼‰
                        this.currentSource = bestSource;

                        this.showDetail = true;

                        if (bestSource && bestSource.vod_play_url) {
                            // è§£ææ’­æ”¾åœ°å€ï¼ˆåªä»è¿™ä¸€ä¸ªèµ„æºç«™å–ï¼‰
                            const urls = bestSource.vod_play_url.split('#').filter(u => u && u.includes('$'));
                            console.log('[è§‚çœ‹å†å²] è§£æåˆ°', urls.length, 'ä¸ªå‰§é›†');

                            if (urls.length > 0) {
                                // æ„å»ºå‰§é›†åˆ—è¡¨ï¼ˆåªç”¨ä¸€ä¸ªèµ„æºç«™çš„ï¼‰
                                this.episodeList = urls.map(u => {
                                    const p = u.split('$');
                                    return { name: p[0], url: p[1] };
                                });

                                // æ‰¾åˆ°å¯¹åº”é›†æ•°
                                let targetEpisode = this.episodeList[0];
                                if (item.episode) {
                                    // ç²¾ç¡®åŒ¹é…é›†æ•°åç§°
                                    const found = this.episodeList.find(ep => ep.name === item.episode);
                                    if (found) {
                                        targetEpisode = found;
                                        console.log('[è§‚çœ‹å†å²] æ‰¾åˆ°åŒ¹é…é›†æ•°:', item.episode);
                                    } else {
                                        console.log('[è§‚çœ‹å†å²] æœªæ‰¾åˆ°åŒ¹é…é›†æ•°:', item.episode, 'ä½¿ç”¨ç¬¬ä¸€é›†');
                                    }
                                }

                                await this.$nextTick();
                                if (targetEpisode && targetEpisode.url) {
                                    this.play(targetEpisode.url, bestSource.site_name);
                                    return;
                                }
                            }
                        }
                    }

                    // æ²¡æœ‰ä¿å­˜çš„æ•°æ®æˆ–è§£æå¤±è´¥ï¼Œä½¿ç”¨æœç´¢
                    console.log('[è§‚çœ‹å†å²] æ²¡æœ‰ä¿å­˜æ•°æ®æˆ–è§£æå¤±è´¥ï¼Œä½¿ç”¨æœç´¢');
                    await this.autoSearch(item.name);
                },

                // æ»šåŠ¨è§‚çœ‹å†å²ï¼ˆä¸è§¦å‘ fetchRowï¼‰
                scrollHistoryRow(direction) {
                    console.log('[å†å²æ»šåŠ¨] ç‚¹å‡»æŒ‰é’®, direction=', direction);
                    let row = this.$refs.watchHistoryRow;
                    console.log('[å†å²æ»šåŠ¨] ref åŸå§‹å€¼:', this.$refs.watchHistoryRow);
                    if (Array.isArray(row)) row = row[0];
                    if (row) {
                        console.log('[å†å²æ»šåŠ¨] æ»šåŠ¨å‰ scrollLeft=', row.scrollLeft);
                        // æ¯æ¬¡æ»šåŠ¨åŠå±å®½åº¦
                        const scrollAmount = row.clientWidth * 0.6;
                        const newScrollLeft = row.scrollLeft + direction * scrollAmount;
                        console.log('[å†å²æ»šåŠ¨] scrollAmount=', scrollAmount, 'newScrollLeft=', newScrollLeft);

                        // é™åˆ¶æ»šåŠ¨èŒƒå›´
                        const maxScroll = row.scrollWidth - row.clientWidth;
                        const finalScrollLeft = Math.max(0, Math.min(newScrollLeft, maxScroll));
                        console.log('[å†å²æ»šåŠ¨] maxScroll=', maxScroll, 'finalScrollLeft=', finalScrollLeft);
                        row.scrollLeft = finalScrollLeft;
                        console.log('[å†å²æ»šåŠ¨] æ»šåŠ¨å scrollLeft=', row.scrollLeft);

                        // æ»šåŠ¨åå»¶è¿Ÿæ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆç­‰å¾…æµè§ˆå™¨å®Œæˆæ»šåŠ¨ï¼‰
                        setTimeout(() => this.updateHistoryScrollNeeded(), 50);
                    } else {
                        console.log('[å†å²æ»šåŠ¨] âŒ row å…ƒç´ æœªæ‰¾åˆ°');
                    }
                },

                // æ£€æŸ¥è§‚çœ‹å†å²æ»šåŠ¨æŒ‰é’®çŠ¶æ€
                updateHistoryScrollNeeded() {
                    let row = this.$refs.watchHistoryRow;
                    if (Array.isArray(row)) row = row[0];
                    if (row) {
                        const scrollLeft = Math.round(row.scrollLeft);
                        const scrollWidth = row.scrollWidth;
                        const clientWidth = row.clientWidth;
                        const maxScroll = scrollWidth - clientWidth;

                        // å·¦æŒ‰é’®ï¼šåªæœ‰æ»šåŠ¨è¿‡æ‰æ˜¾ç¤º
                        this.historyCanScrollLeft = scrollLeft > 10;
                        // å³æŒ‰é’®ï¼šåªæœ‰å½“å³ä¾§è¿˜æœ‰æœªæ˜¾ç¤ºå†…å®¹æ—¶æ˜¾ç¤º
                        this.historyCanScrollRight = maxScroll > 10 && scrollLeft < maxScroll - 10;

                        console.log('[å†å²æŒ‰é’®çŠ¶æ€] scrollLeft=', scrollLeft, 'maxScroll=', maxScroll,
                            'canLeft=', this.historyCanScrollLeft, 'canRight=', this.historyCanScrollRight);
                    } else {
                        this.historyCanScrollLeft = false;
                        this.historyCanScrollRight = false;
                    }
                },

                // ç›‘å¬è§‚çœ‹å†å²æ»šåŠ¨äº‹ä»¶
                onHistoryScroll() {
                    this.updateHistoryScrollNeeded();
                },

                // ç›‘å¬åˆ†ç±»æ¦œå•æ»šåŠ¨äº‹ä»¶
                onRowScroll(key) {
                    let row = this.$refs[key];
                    if (Array.isArray(row)) row = row[0]; // v-for ref ä¿®æ­£
                    if (row) {
                        // åªè¦æ»šè¿‡ä¸€ç‚¹ç‚¹ï¼Œå°±æ˜¾ç¤ºå·¦æŒ‰é’®
                        const showLeft = row.scrollLeft > 10;
                        if (this.rowLeftButtons[key] !== showLeft) {
                            this.rowLeftButtons = { ...this.rowLeftButtons, [key]: showLeft };
                        }

                        // æ‰‹æœºç«¯ï¼šæ»‘åŠ¨æ¥è¿‘å³è¾¹ç¼˜æ—¶è‡ªåŠ¨åŠ è½½æ›´å¤š
                        const nearRightEdge = row.scrollLeft + row.clientWidth >= row.scrollWidth - 300;
                        if (nearRightEdge) {
                            this.fetchRow(key, true);
                        }
                    }
                },
                // åˆ‡æ¢æ¦œå•å±•å¼€/æ”¶èµ·çŠ¶æ€
                toggleRowExpand(key) {
                    const isExpanding = !this.expandedRows[key];
                    console.log(`[DEBUG toggleRowExpand] key=${key}, isExpanding=${isExpanding}, viewPages[key] before=`, this.viewPages[key]);
                    this.expandedRows = { ...this.expandedRows, [key]: isExpanding };
                    // å±•å¼€æ—¶åˆå§‹åŒ–é¡µç ä¸º 1ï¼ˆä½¿ç”¨å“åº”å¼æ–¹å¼ï¼‰
                    if (isExpanding && this.viewPages[key] === undefined) {
                        this.viewPages = { ...this.viewPages, [key]: 1 };
                        console.log(`[DEBUG toggleRowExpand] Initialized viewPages[${key}] = 1`);
                    }
                    console.log(`[DEBUG toggleRowExpand] viewPages[key] after=`, this.viewPages[key]);
                },
                // æ»šåŠ¨åˆ°æŒ‡å®šåŒºåŸŸ
                scrollToSection(refName) {
                    let el = this.$refs[refName];
                    if (Array.isArray(el)) el = el[0]; // v-for ref ä¿®æ­£
                    if (el) {
                        const top = el.getBoundingClientRect().top + window.scrollY - 100;
                        window.scrollTo({ top: top, behavior: 'smooth' });
                    }
                },

                // è·å–å½“å‰æŸ¥çœ‹é¡µçš„æ•°æ®ï¼ˆæ¯é¡µ20æ¡ï¼‰
                getPagedItems(key) {
                    const items = this.rowLists[key] || [];
                    const page = this.viewPages[key] || 1;
                    const perPage = 20;
                    const start = (page - 1) * perPage;
                    return items.slice(start, start + perPage);
                },

                // è·å–æ€»æŸ¥çœ‹é¡µæ•°
                getTotalViewPages(key) {
                    const items = this.rowLists[key] || [];
                    return Math.ceil(items.length / 20) || 1;
                },

                // åˆ‡æ¢æŸ¥çœ‹é¡µï¼ˆå¸¦èŠ‚æµä¿æŠ¤ï¼‰
                changeViewPage(key, delta) {
                    console.log(`[DEBUG changeViewPage] START: key=${key}, delta=${delta}`);
                    console.log(`[DEBUG changeViewPage] viewPages[key] BEFORE =`, this.viewPages[key]);

                    // ç¡®ä¿åˆå§‹å€¼å­˜åœ¨ï¼ˆä½¿ç”¨å“åº”å¼æ–¹å¼ï¼‰
                    if (this.viewPages[key] === undefined) {
                        console.log(`[DEBUG changeViewPage] viewPages[${key}] is undefined, initializing to 1`);
                        this.viewPages = { ...this.viewPages, [key]: 1 };
                    }

                    const currentPage = this.viewPages[key];
                    const newPage = currentPage + delta;
                    const totalPages = this.getTotalViewPages(key);

                    console.log(`[DEBUG changeViewPage] currentPage=${currentPage}, newPage=${newPage}, totalPages=${totalPages}`);

                    // æœ¬åœ°ç¿»é¡µï¼ˆä¸éœ€è¦ APIï¼‰å¯ä»¥ç«‹å³æ‰§è¡Œ
                    if (newPage >= 1 && newPage <= totalPages) {
                        console.log(`[DEBUG changeViewPage] Condition passed, setting viewPages[${key}] = ${newPage}`);
                        this.viewPages = { ...this.viewPages, [key]: newPage };
                        console.log(`[DEBUG changeViewPage] viewPages[key] AFTER =`, this.viewPages[key]);
                        // ç¿»é¡µåæ»šåŠ¨åˆ°åˆ†ç±»æ ‡é¢˜ä½ç½®
                        console.log(`[ç¿»é¡µæ»šåŠ¨] å¼€å§‹å¤„ç† key=${key}`);
                        this.$nextTick(() => {
                            console.log(`[ç¿»é¡µæ»šåŠ¨] $nextTick è§¦å‘`);
                            const refKey = key + '-section';
                            console.log(`[ç¿»é¡µæ»šåŠ¨] æŸ¥æ‰¾ ref: ${refKey}`);
                            console.log(`[ç¿»é¡µæ»šåŠ¨] $refs æ‰€æœ‰é”®:`, Object.keys(this.$refs));
                            const sectionRef = this.$refs[refKey];
                            console.log(`[ç¿»é¡µæ»šåŠ¨] sectionRef =`, sectionRef);
                            let el = Array.isArray(sectionRef) ? sectionRef[0] : sectionRef;
                            console.log(`[ç¿»é¡µæ»šåŠ¨] el =`, el);
                            if (el) {
                                const rect = el.getBoundingClientRect();
                                console.log(`[ç¿»é¡µæ»šåŠ¨] rect =`, rect);
                                console.log(`[ç¿»é¡µæ»šåŠ¨] window.pageYOffset =`, window.pageYOffset);
                                const targetY = window.pageYOffset + rect.top - 80;
                                console.log(`[ç¿»é¡µæ»šåŠ¨] ç›®æ ‡ä½ç½® targetY =`, targetY);
                                window.scrollTo(0, targetY);
                                console.log(`[ç¿»é¡µæ»šåŠ¨] scrollTo å·²è°ƒç”¨`);
                            } else {
                                console.log(`[ç¿»é¡µæ»šåŠ¨] âŒ æœªæ‰¾åˆ°å…ƒç´ `);
                            }
                        });
                    } else {
                        console.log(`[DEBUG changeViewPage] Condition FAILED: newPage=${newPage}, totalPages=${totalPages}`);

                        // å¦‚æœæ˜¯å› ä¸ºæ•°æ®è¿˜æ²¡åŠ è½½å®Œå¯¼è‡´ç¿»é¡µå¤±è´¥ï¼Œè®°å½•ç›®æ ‡é¡µç 
                        // ç­‰æ•°æ®åŠ è½½å®Œæˆåè‡ªåŠ¨ç¿»é¡µ
                        if (newPage > totalPages && this.rowConfigs[key].page < (this.rowConfigs[key].totalPages || 999)) {
                            console.log(`[DEBUG changeViewPage] Setting pending page for ${key}: ${newPage}`);
                            this._pendingPage = this._pendingPage || {};
                            this._pendingPage[key] = newPage;
                        }
                    }

                    // å¦‚æœéœ€è¦åŠ è½½æ›´å¤šæ•°æ®ï¼Œæ·»åŠ èŠ‚æµä¿æŠ¤ï¼ˆ500ms é—´éš”ï¼‰
                    if (newPage >= totalPages && this.rowConfigs[key].page < (this.rowConfigs[key].totalPages || 999)) {
                        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨åŠ è½½ä¸­
                        if (this.pageLoadingKeys[key]) {
                            console.log(`[${key}] è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•`);
                            return;
                        }
                        // è®¾ç½®åŠ è½½é”
                        this.pageLoadingKeys[key] = true;

                        // åŠ è½½æ›´å¤šæ•°æ®ï¼Œå¹¶åœ¨å®Œæˆåæ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨ç¿»é¡µ
                        this.fetchRow(key, true).then(() => {
                            // æ£€æŸ¥æ˜¯å¦æœ‰å¾…æ‰§è¡Œçš„ç¿»é¡µ
                            if (this._pendingPage && this._pendingPage[key]) {
                                const pendingPage = this._pendingPage[key];
                                const newTotalPages = this.getTotalViewPages(key);
                                console.log(`[DEBUG] Data loaded, checking pending page ${pendingPage}, new totalPages=${newTotalPages}`);
                                if (pendingPage <= newTotalPages) {
                                    console.log(`[DEBUG] Auto-flipping to page ${pendingPage}`);
                                    this.viewPages = { ...this.viewPages, [key]: pendingPage };
                                }
                                delete this._pendingPage[key];
                            }
                        });

                        // 500ms åè§£é”
                        setTimeout(() => {
                            this.pageLoadingKeys[key] = false;
                        }, 500);
                    }
                },

                // å¤„ç†åˆ†ç±»ç‚¹å‡»
                handleCatClick(item) {
                    if (item.action === 'scroll') {
                        this.scrollToSection(item.value);
                    } else if (item.action === 'search') {
                        this.autoSearch(item.value);
                    }
                },

                // è·å–æµ·æŠ¥å›¾ç‰‡é“¾æ¥ (è‡ªåŠ¨é€‚é…æœ¬åœ°/è¿œç¨‹)
                getPosterUrl(path, size = 'w300') {
                    if (!path) {
                        return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='450'%3E%3Crect fill='%23333' width='300' height='450'/%3E%3Ctext fill='%23666' x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='20'%3ENo Image%3C/text%3E%3C/svg%3E";
                    }
                    // å¦‚æœé…ç½®äº†æœ¬åœ°ç¼“å­˜ URLï¼Œä½¿ç”¨å®ƒ (æ³¨æ„å»æ‰ size éƒ¨åˆ†å› ä¸ºå·²åŒ…å«åœ¨ path é‡Œ? ä¸ï¼Œpathåªæ˜¯ /xxxx.jpg)
                    // TMDB_IMG_URL æ ¼å¼å¯èƒ½æ˜¯ "/api/tmdb-image/w342" æˆ– "https://image.tmdb.org/t/p/w342"
                    return this.TMDB_IMG_URL + path;
                },

                // é˜²æŠ–æœç´¢ - è¾“å…¥æ—¶å®æ—¶æœç´¢
                debouncedSearch() {
                    clearTimeout(this.searchTimer);
                    if (!this.keyword || this.keyword.length < 2) {
                        // å…³é”®è¯å¤ªçŸ­æ—¶ä¸æœç´¢ï¼Œæ¸…é™¤ç»“æœ
                        if (!this.keyword) {
                            this.searched = false;
                            this.rawList = [];
                        }
                        return;
                    }
                    this.searchTimer = setTimeout(() => {
                        this.doSearch();
                    }, 500);  // 500ms é˜²æŠ–å»¶è¿Ÿ
                },

                // æ˜¾ç¤ºç”µå½±è¯¦æƒ…å¼¹çª—
                showMovieInfo(item) {
                    this.infoModalData = item;
                    this.showInfoModal = true;
                },

                // è®¾ç½® TMDB åä»£ï¼ˆé’ˆå¯¹å¤§é™†ç”¨æˆ·ï¼‰
                async setupTmdbProxy(proxyUrl) {
                    let isCN = false;
                    try {
                        // 1. ä¼˜å…ˆä½¿ç”¨ Cloudflare Trace (ç¨³å®šã€æ— é€Ÿç‡é™åˆ¶)
                        const res = await fetch('https://www.cloudflare.com/cdn-cgi/trace', { timeout: 3000 });
                        if (res.ok) {
                            const text = await res.text();
                            const matches = text.match(/loc=([A-Z]+)/);
                            if (matches && matches[1] === 'CN') isCN = true;
                        } else {
                            throw new Error('CF Trace Status: ' + res.status);
                        }
                    } catch (e) {
                        // 2. é™çº§åˆ° ipapi.co (æœ‰é€Ÿç‡é™åˆ¶ï¼Œä»…ä½œä¸ºå¤‡é€‰)
                        console.log('[IPæ£€æµ‹] CF Trace å¤±è´¥ï¼Œå°è¯• ipapi.co...');
                        try {
                            const res = await fetch('https://ipapi.co/json/', { timeout: 3000 });
                            if (res.ok) {
                                const data = await res.json();
                                if (data.country_code === 'CN') isCN = true;
                            } else {
                                console.warn('[IPæ£€æµ‹] ipapi.co å“åº”å¼‚å¸¸:', res.status);
                            }
                        } catch (e2) {
                            console.warn('[IPæ£€æµ‹] æ‰€æœ‰æ¥å£å‡å¤±è´¥ï¼Œæ— æ³•è‡ªåŠ¨åˆ‡æ¢çº¿è·¯', e2);
                        }
                    }

                    if (isCN) {
                        console.log('[IPæ£€æµ‹] æ£€æµ‹åˆ°å¤§é™†IPï¼Œå¯ç”¨TMDBåä»£:', proxyUrl);
                        TMDB_BASE_URL = proxyUrl + '/api/3';
                        TMDB_IMG_URL = proxyUrl + '/t/p/w342';
                        TMDB_BACKDROP_URL = proxyUrl + '/t/p/original';
                    } else {
                        console.log('[IPæ£€æµ‹] éå¤§é™†IPæˆ–æ£€æµ‹å®Œæˆï¼Œä¿æŒå®˜æ–¹åœ°å€');
                    }
                },

                // æ¸…ç† HTML æ ‡ç­¾
                stripHtml(html) {
                    if (!html) return '';
                    return html.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ').trim();
                },

                getLatencyClass(ms) { return ms < 500 ? 'dot-green' : (ms < 2000 ? 'dot-yellow' : 'dot-red'); },
                castVideo() {
                    const videoEl = document.querySelector('.dplayer-video');
                    if (!videoEl) return alert('è¯·å…ˆæ’­æ”¾è§†é¢‘');
                    if (videoEl.remote && videoEl.remote.state !== 'disconnected') videoEl.remote.prompt().catch(() => { });
                    else if (videoEl.webkitShowPlaybackTargetPicker) videoEl.webkitShowPlaybackTargetPicker();
                    else alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç½‘é¡µç›´æ¥æŠ•å±ï¼Œè¯·ä½¿ç”¨æµè§ˆå™¨èœå•ä¸­çš„æŠ•å°„åŠŸèƒ½ã€‚');
                },

                scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); },

                goHome() {
                    this.scrollToTop();
                    // å…³é—­æ’­æ”¾è¯¦æƒ…é¡µ
                    this.showDetail = false;
                    if (dp) dp.pause();
                    // æ¸…é™¤æœç´¢çŠ¶æ€
                    this.searched = false;
                    this.keyword = '';
                    this.rawList = [];
                    // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },

                // åŠ è½½å•ä¸ªæ¦œå•æ•°æ®
                fetchRow(key, loadMore = false) {
                    const config = this.rowConfigs[key];
                    if (!config) return Promise.resolve();

                    if (loadMore) {
                        // æ£€æŸ¥æ˜¯å¦å·²åˆ°è¾¾ API è¿”å›çš„æ€»é¡µæ•°
                        if (config.totalPages && config.page >= config.totalPages) {
                            console.log(`[${key}] å·²åŠ è½½å…¨éƒ¨ ${config.totalPages} é¡µ`);
                            return Promise.resolve();
                        }
                        config.page++;
                    }

                    const url = `${TMDB_BASE_URL}${config.path}?api_key=${TMDB_API_KEY}&language=zh-CN&page=${config.page}&${config.params}`;
                    return fetch(url)
                        .then(res => res.json())
                        .then(data => {
                            if (data.results) {
                                // ä¿å­˜æ€»é¡µæ•°ä¿¡æ¯
                                if (data.total_pages) {
                                    config.totalPages = data.total_pages;
                                }
                                // ç¡®ä¿å“åº”å¼æ›´æ–°
                                if (!this.rowLists[key]) {
                                    this.rowLists[key] = data.results;
                                } else if (loadMore) {
                                    this.rowLists[key].push(...data.results);
                                } else {
                                    this.rowLists[key] = data.results;
                                }
                            }
                        })
                        .catch(err => console.error(`Fetch error for ${key}:`, err));
                },

                // åˆå§‹åŒ–æ¦œå• (å…¨éƒ¨ç›´æ¥åŠ è½½ï¼Œé¿å…æ‡’åŠ è½½é—®é¢˜)
                fetchAllLists() {
                    const keys = Object.keys(this.rowConfigs);

                    // è®¾å¤‡æ£€æµ‹ï¼ˆä»…ç”¨äºæ—¥å¿—ï¼‰
                    const viewportWidth = window.innerWidth;
                    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                    const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    const isMobile = viewportWidth < 768 || (isTouchDevice && viewportWidth < 1024) || isMobileUA;

                    console.log(`[è®¾å¤‡æ£€æµ‹] å®½åº¦=${viewportWidth}, è§¦æ‘¸=${isTouchDevice}, UAç§»åŠ¨=${isMobileUA}, åˆ¤å®š=${isMobile ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯'}`);

                    // ç»Ÿä¸€ä½¿ç”¨ç›´æ¥åŠ è½½æ‰€æœ‰æ¦œå•ï¼ˆæ— è®ºç§»åŠ¨ç«¯è¿˜æ˜¯æ¡Œé¢ç«¯ï¼‰
                    console.log(`[æ¦œå•åŠ è½½] ç›´æ¥åŠ è½½æ‰€æœ‰ ${keys.length} ä¸ªæ¦œå•`);
                    keys.forEach((key, index) => {
                        // æ¯ä¸ªæ¦œå•é—´éš” 200ms åŠ è½½ï¼Œé¿å… API é€Ÿç‡é™åˆ¶
                        setTimeout(() => {
                            this.fetchRow(key);
                        }, index * 200);
                    });
                },

                scrollRow(refName, direction) {
                    let row = this.$refs[refName];
                    // v-for ä¸­çš„ ref æ˜¯æ•°ç»„
                    if (Array.isArray(row)) row = row[0];

                    if (row) {
                        // æ¯æ¬¡æ»šåŠ¨åŠå±å®½åº¦
                        const scrollAmount = row.clientWidth * 0.6;
                        row.scrollLeft += direction * scrollAmount;

                        // å‘å³æ»šåŠ¨æ—¶è§¦å‘åŠ è½½ä¸‹ä¸€é¡µ
                        if (direction > 0) {
                            this.fetchRow(refName, true);
                        }
                    }
                },

                fetchHero() {
                    return fetch(`${TMDB_BASE_URL}/trending/all/week?api_key=${TMDB_API_KEY}&language=zh-CN`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.results) {
                                this.heroList = data.results.filter(i => i.backdrop_path).slice(0, 5).map(item => ({
                                    title: item.title || item.name,
                                    overview: item.overview || 'ç²¾å½©å†…å®¹ä¸å®¹é”™è¿‡',
                                    backdrop: `${TMDB_BACKDROP_URL}${item.backdrop_path}`,
                                    rawData: item  // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºå¼¹çª—
                                }));
                            }
                        });
                },

                finalPoster(item, isHot = false) {
                    const name = isHot ? item.vod_name : item.name;
                    return this.imageMap[name] || (isHot ? item.vod_pic : item.pic);
                },
                isFallback(name) { return this.fallbackMap[name] === true; },

                handleImgError(name) {
                    if (this.imageMap[name] || this.fallbackMap[name]) return;
                    this.fallbackMap[name] = true;
                    let cleanName = name.replace(/ç¬¬[0-9ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+[å­£éƒ¨]/g, '').replace(/Season\s*\d+/ig, '').replace(/S\d{1,2}/ig, '').replace(/(HD|BD|1080P|720P|4K|202\d|TC|TS).*/i, '').trim();
                    fetch(`${TMDB_BASE_URL}/search/multi?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(cleanName)}&language=zh-CN`)
                        .then(res => res.json()).then(data => {
                            if (data.results && data.results.length > 0) {
                                const found = data.results.find(i => i.poster_path) || data.results[0];
                                if (found.poster_path) {
                                    this.imageMap[name] = `${TMDB_IMG_URL}${found.poster_path}`;
                                    this.fallbackMap[name] = false;
                                }
                            }
                        }).catch(() => { });
                },



                autoSearch(name) {
                    this.keyword = name;
                    this.doSearch();
                },
                clearSearch() { this.searched = false; this.keyword = ''; this.rawList = []; },
                doSearch() {
                    if (!this.keyword) return;

                    if (this._evtSource) {
                        this._evtSource.close();
                        this._evtSource = null;
                    }

                    this.loading = true;
                    this.searched = true;
                    this.rawList = [];
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                    const url = `/api/search?wd=${encodeURIComponent(this.keyword)}&stream=true`;
                    this._evtSource = new EventSource(url);

                    this._evtSource.onmessage = (e) => {
                        try {
                            const newItems = JSON.parse(e.data);
                            if (Array.isArray(newItems) && newItems.length > 0) {
                                this.rawList = this.rawList.concat(newItems);
                                newItems.forEach(item => {
                                    if (!item.vod_pic || item.vod_pic.includes('mac_default')) this.handleImgError(item.vod_name);
                                });
                            }
                        } catch (err) { }
                    };

                    this._evtSource.addEventListener('done', () => {
                        this.loading = false;
                        if (this._evtSource) {
                            this._evtSource.close();
                            this._evtSource = null;
                        }
                    });

                    this._evtSource.onerror = () => {
                        this.loading = false;
                        if (this._evtSource) {
                            this._evtSource.close();
                            this._evtSource = null;
                        }
                    };
                },
                async openDetail(group) {
                    this.currentGroup = group;
                    this.showDetail = true;
                    this.isTestingSources = true;  // å¼€å§‹æµ‹é€Ÿ
                    this.currentSource = null;  // ç¡®ä¿æ¸…ç©ºä¹‹å‰çš„é€‰æ‹©
                    this.episodeList = [];

                    // çœŸå®ç”¨æˆ·ç«¯æµ‹é€Ÿï¼šè·å–æ¯ä¸ªçº¿è·¯çš„è§†é¢‘URLï¼Œç›´æ¥ä»ç”¨æˆ·ç«¯æµ‹è¯•m3u8å»¶è¿Ÿ
                    // è¿™æ ·èƒ½çœŸæ­£åæ˜ ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®è¯¥è§†é¢‘æº

                    // å¿«é€Ÿè¿”å›æ ‡å¿—ï¼šä¸€æ—¦æœ‰2+å¿«é€Ÿçº¿è·¯ï¼Œç«‹å³è‡ªåŠ¨é€‰æ‹©æœ€å¿«çš„
                    let hasAutoSelected = false;
                    const FAST_THRESHOLD = 600;  // å¿«é€Ÿçº¿è·¯é˜ˆå€¼ (ms)
                    const EARLY_RETURN_COUNT = 2;  // æœ‰å‡ ä¸ªå¿«é€Ÿçº¿è·¯åæå‰è¿”å›
                    const MAX_WAIT_TIME = 3000;  // æœ€é•¿ç­‰å¾…æ—¶é—´ (ms)

                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æå‰è¿”å› - ä¼˜å…ˆç”¨æˆ·ç«¯æµ‹é€Ÿç»“æœ
                    const checkEarlyReturn = () => {
                        if (hasAutoSelected) return;

                        // ä¼˜å…ˆæ£€æŸ¥ç”¨æˆ·ç«¯æµ‹é€Ÿ(direct)çš„å¿«é€Ÿçº¿è·¯
                        const directFastSources = this.currentGroup.sources.filter(s =>
                            s._testType === 'direct' && typeof s.latency === 'number' && s.latency < FAST_THRESHOLD
                        );

                        if (directFastSources.length >= EARLY_RETURN_COUNT) {
                            hasAutoSelected = true;
                            directFastSources.sort((a, b) => a.latency - b.latency);
                            console.log(`[å¿«é€Ÿè¿”å›] å·²æ‰¾åˆ° ${directFastSources.length} ä¸ªç”¨æˆ·ç«¯å¿«é€Ÿçº¿è·¯ï¼Œè‡ªåŠ¨é€‰æ‹©: ${directFastSources[0].site_name} (${directFastSources[0].latency}ms ğŸ¬)`);
                            this.switchSource(directFastSources[0]);
                        }
                    };

                    // è¶…æ—¶è‡ªåŠ¨é€‰æ‹©ï¼ˆä¼˜å…ˆç”¨æˆ·ç«¯æµ‹é€Ÿï¼Œå…¶æ¬¡æœåŠ¡å™¨ç«¯ï¼‰
                    const earlyReturnTimer = setTimeout(() => {
                        if (hasAutoSelected) return;
                        hasAutoSelected = true;

                        // ä¼˜å…ˆé€‰æ‹©ç”¨æˆ·ç«¯æµ‹é€Ÿçš„ç»“æœ
                        let directSources = this.currentGroup.sources.filter(s =>
                            s._testType === 'direct' && typeof s.latency === 'number' && s.latency < 9000
                        );

                        if (directSources.length > 0) {
                            directSources.sort((a, b) => a.latency - b.latency);
                            console.log(`[è¶…æ—¶è¿”å›] é€‰æ‹©ç”¨æˆ·ç«¯æµ‹é€Ÿæœ€å¿«çš„: ${directSources[0].site_name} (${directSources[0].latency}ms ğŸ¬)`);
                            this.switchSource(directSources[0]);
                            return;
                        }

                        // æ²¡æœ‰ç”¨æˆ·ç«¯æµ‹é€Ÿç»“æœï¼Œå›é€€åˆ°æœåŠ¡å™¨ç«¯
                        const testedSources = this.currentGroup.sources.filter(s =>
                            typeof s.latency === 'number' && s.latency < 9000
                        );

                        if (testedSources.length > 0) {
                            testedSources.sort((a, b) => a.latency - b.latency);
                            console.log(`[è¶…æ—¶è¿”å›] ${MAX_WAIT_TIME}msåè‡ªåŠ¨é€‰æ‹©: ${testedSources[0].site_name} (${testedSources[0].latency}ms)`);
                            this.switchSource(testedSources[0]);
                        }
                    }, MAX_WAIT_TIME);

                    const latencyPromises = this.currentGroup.sources.map(async (source) => {
                        source.latency = '...';
                        try {
                            // 1. å…ˆè·å–è¯¥çº¿è·¯çš„è§†é¢‘è¯¦æƒ…
                            const detailRes = await fetch(`/api/detail?site_key=${source.site_key}&id=${source.vod_id}`);
                            const detailData = await detailRes.json();

                            if (!detailData.list || detailData.list.length === 0) {
                                source.latency = 9999;
                                return source;
                            }

                            // 2. è§£æå‡ºç¬¬ä¸€ä¸ª m3u8 è§†é¢‘ URL
                            const detail = detailData.list[0];
                            let playUrl = detail.vod_play_url || '';

                            // å¤„ç†å¤šçº¿è·¯æ ¼å¼ (ç”¨ $$$ åˆ†éš”)
                            if (playUrl.includes('$$$')) {
                                const sets = playUrl.split('$$$');
                                playUrl = sets.find(s => s.toLowerCase().includes('m3u8')) || sets[0];
                            }

                            // è·å–ç¬¬ä¸€ä¸ªè§†é¢‘URL
                            const firstEp = playUrl.split('#')[0];
                            const parts = firstEp.split('$');
                            const videoUrl = parts.length > 1 ? parts[1] : parts[0];

                            if (!videoUrl || !videoUrl.startsWith('http')) {
                                source.latency = 9999;
                                return source;
                            }

                            // æ£€æŸ¥æ··åˆå†…å®¹ï¼šå¦‚æœé¡µé¢æ˜¯ HTTPS ä½†è§†é¢‘ URL æ˜¯ HTTPï¼Œå›é€€åˆ°æœåŠ¡å™¨ç«¯æµ‹é€Ÿ
                            const isPageHttps = window.location.protocol === 'https:';
                            const isVideoHttp = videoUrl.startsWith('http:');

                            if (isPageHttps && isVideoHttp) {
                                // æ··åˆå†…å®¹ï¼Œæ— æ³•ç›´æ¥æµ‹è¯•ï¼Œå›é€€åˆ°æœåŠ¡å™¨ç«¯å»¶è¿Ÿ
                                console.log(`[æ··åˆå†…å®¹] ${source.site_name} è§†é¢‘URLä¸ºHTTPï¼Œå›é€€åˆ°æœåŠ¡å™¨æµ‹é€Ÿ`);
                                const checkRes = await fetch(`/api/check?key=${source.site_key}`);
                                const checkData = await checkRes.json();
                                source.latency = checkData.latency;
                                source._testType = 'server';  // æœåŠ¡å™¨ç«¯æµ‹é€Ÿ
                                source._cachedDetail = detail;
                                checkEarlyReturn();
                                return source;
                            }

                            // 3. ç”¨æˆ·ç«¯ç›´æ¥æµ‹è¯• m3u8 URL çš„å»¶è¿Ÿ
                            const startTime = Date.now();
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 5000);

                            // m3u8 æ–‡ä»¶é€šå¸¸é…ç½®äº† CORSï¼Œå¯ä»¥ç›´æ¥ fetch
                            const testRes = await fetch(videoUrl, {
                                method: 'GET',
                                cache: 'no-cache',
                                signal: controller.signal
                            });

                            clearTimeout(timeoutId);

                            if (testRes.ok || testRes.type === 'cors') {
                                source.latency = Date.now() - startTime;
                            } else {
                                source.latency = Date.now() - startTime;
                            }

                            // ç¼“å­˜è¯¦æƒ…æ•°æ®ï¼Œåç»­åˆ‡æ¢æ—¶å¯ä»¥å¤ç”¨
                            source._cachedDetail = detail;
                            source._testType = 'direct';  // ç”¨æˆ·ç«¯ç›´æ¥æµ‹é€Ÿ

                            // æ¯å®Œæˆä¸€ä¸ªæµ‹é€Ÿå°±æ£€æŸ¥æ˜¯å¦å¯ä»¥æå‰è¿”å›
                            checkEarlyReturn();

                        } catch (e) {
                            // å¦‚æœæ˜¯ CORS é”™è¯¯ï¼Œå°è¯• no-cors æ¨¡å¼å†æµ‹ä¸€æ¬¡
                            if (e.name !== 'AbortError') {
                                try {
                                    const detailRes = await fetch(`/api/detail?site_key=${source.site_key}&id=${source.vod_id}`);
                                    const detailData = await detailRes.json();
                                    if (detailData.list && detailData.list.length > 0) {
                                        source._cachedDetail = detailData.list[0];
                                        // æ— æ³•ç›´æ¥æµ‹è¯•ï¼Œå›é€€åˆ°æœåŠ¡å™¨ç«¯å»¶è¿Ÿ
                                        const checkRes = await fetch(`/api/check?key=${source.site_key}`);
                                        const checkData = await checkRes.json();
                                        source.latency = checkData.latency;
                                        source._testType = 'server';  // æœåŠ¡å™¨ç«¯æµ‹é€Ÿ
                                        checkEarlyReturn();
                                    } else {
                                        source.latency = 9999;
                                    }
                                } catch (e2) {
                                    source.latency = 9999;
                                }
                            } else {
                                source.latency = 9999;  // è¶…æ—¶
                            }
                        }
                        return source;
                    });

                    // ç­‰å¾…æ‰€æœ‰æµ‹é€Ÿå®Œæˆï¼ˆåå°ç»§ç»­ï¼‰
                    await Promise.all(latencyPromises);
                    clearTimeout(earlyReturnTimer);
                    this.isTestingSources = false;  // æµ‹é€Ÿå®Œæˆ

                    // æŒ‰å»¶è¿Ÿæ’åº (ä½åˆ°é«˜)
                    this.currentGroup.sources.sort((a, b) => {
                        const latA = typeof a.latency === 'number' ? a.latency : 9999;
                        const latB = typeof b.latency === 'number' ? b.latency : 9999;
                        return latA - latB;
                    });

                    // å¦‚æœå·²ç»æœ‰é€‰ä¸­çš„æºå¹¶ä¸”è§†é¢‘å·²å¼€å§‹æ’­æ”¾ï¼Œä¸å†è‡ªåŠ¨åˆ‡æ¢
                    // è¿™æ ·ä¸ä¼šæ‰“æ–­ç”¨æˆ·æ­£åœ¨è§‚çœ‹çš„å†…å®¹
                    if (hasAutoSelected && this.currentSource && this.currentUrl) {
                        console.log(`[æµ‹é€Ÿå®Œæˆ] ä¿æŒå½“å‰çº¿è·¯: ${this.currentSource.site_name}ï¼Œä¸è‡ªåŠ¨åˆ‡æ¢`);
                        return;
                    }

                    // å¦‚æœè¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•æºï¼Œé€‰æ‹©æœ€å¿«çš„
                    if (!hasAutoSelected) {
                        // ä¼˜å…ˆé€‰æ‹©ç”¨æˆ·ç«¯æµ‹é€Ÿ(direct)çš„ç»“æœ
                        const directSources = this.currentGroup.sources.filter(s =>
                            s._testType === 'direct' && typeof s.latency === 'number' && s.latency < 9000
                        );

                        if (directSources.length > 0) {
                            console.log(`[æµ‹é€Ÿå®Œæˆ] é€‰æ‹©ç”¨æˆ·ç«¯æµ‹é€Ÿæœ€å¿«çš„çº¿è·¯: ${directSources[0].site_name} (${directSources[0].latency}ms)`);
                            this.switchSource(directSources[0]);
                        } else {
                            // å›é€€åˆ°æœåŠ¡å™¨ç«¯æµ‹é€Ÿæœ€å¿«çš„
                            const fastestAvailable = this.currentGroup.sources.find(s =>
                                typeof s.latency === 'number' && s.latency < 9000
                            );
                            if (fastestAvailable) {
                                console.log(`[æµ‹é€Ÿå®Œæˆ] é€‰æ‹©æœåŠ¡å™¨æµ‹é€Ÿæœ€å¿«çš„çº¿è·¯: ${fastestAvailable.site_name} (${fastestAvailable.latency}ms)`);
                                this.switchSource(fastestAvailable);
                            }
                        }
                    }
                    // å¦‚æœå…¨éƒ¨ä¸å¯ç”¨ï¼Œä¸è‡ªåŠ¨é€‰æ‹©ï¼ŒUIä¼šæ˜¾ç¤ºæç¤º
                },
                closeDetail() { this.showDetail = false; if (dp) dp.pause(); },
                async switchSource(source) {
                    this.currentSource = source;
                    this.loadingDetail = true;

                    // è®°ä½å½“å‰é›†æ•°åç§°ï¼Œåˆ‡æ¢åå°è¯•ä¿ç•™ï¼ˆåœ¨æ¸…ç©ºä¹‹å‰è·å–ï¼ï¼‰
                    const previousEpName = this.episodeList?.find(ep => ep.url === this.currentUrl)?.name;
                    console.log('[åˆ‡æ¢èµ„æº] å½“å‰é›†æ•°:', previousEpName);

                    this.episodeList = [];

                    try {

                        // å¦‚æœ source å·²ç»æœ‰ vod_play_urlï¼ˆæ¥è‡ªå†å²è®°å½•ï¼‰ï¼Œç›´æ¥ä½¿ç”¨
                        if (source.vod_play_url) {
                            console.log('[åˆ‡æ¢èµ„æº] ä½¿ç”¨å·²æœ‰çš„ vod_play_url');
                            this.parseEpisodes(source.vod_play_url, previousEpName);
                            this.loadingDetail = false;
                            return;
                        }

                        // ä¼˜å…ˆä½¿ç”¨æµ‹é€Ÿæ—¶ç¼“å­˜çš„è¯¦æƒ…æ•°æ®
                        let detail = source._cachedDetail;

                        if (!detail) {
                            // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œé‡æ–°è·å–
                            const res = await fetch(`/api/detail?site_key=${source.site_key}&id=${source.vod_id}`);
                            const data = await res.json();
                            if (data.list && data.list.length > 0) {
                                detail = data.list[0];
                            }
                        }

                        if (detail) {
                            // ä¿å­˜ç®€ä»‹ä¿¡æ¯åˆ°å½“å‰æº
                            this.currentSource.vod_content = detail.vod_content || detail.vod_blurb || '';
                            this.parseEpisodes(detail.vod_play_url, previousEpName);
                        }
                    } catch (e) { console.log('[åˆ‡æ¢èµ„æº] é”™è¯¯:', e); }
                    this.loadingDetail = false;
                },

                // è§£æå‰§é›†åˆ—è¡¨ï¼Œå°è¯•åŒ¹é…æŒ‡å®šé›†æ•°
                parseEpisodes(urlStr, targetEpName) {
                    let playSource = urlStr;
                    if (urlStr.includes('$$$')) {
                        const sets = urlStr.split('$$$');
                        playSource = sets.find(s => s.toLowerCase().includes('m3u8')) || sets[0];
                    }
                    this.episodeList = playSource.split('#').map(ep => {
                        const p = ep.split('$');
                        return { name: p.length > 1 ? p[0] : 'æ­£ç‰‡', url: p.length > 1 ? p[1] : p[0] };
                    });

                    if (this.episodeList.length > 0) {
                        // å°è¯•æ‰¾åˆ°ä¸ä¹‹å‰ç›¸åŒåç§°çš„é›†æ•°
                        let targetEp = this.episodeList[0];
                        if (targetEpName) {
                            // æ ‡å‡†åŒ–é›†æ•°åç§°è¿›è¡ŒåŒ¹é…
                            const normalize = (name) => name?.replace(/ç¬¬0*(\d+)é›†/g, 'ç¬¬$1é›†') || '';
                            const normalizedTarget = normalize(targetEpName);

                            const found = this.episodeList.find(ep => normalize(ep.name) === normalizedTarget);
                            if (found) {
                                targetEp = found;
                                console.log('[åˆ‡æ¢èµ„æº] æ‰¾åˆ°åŒ¹é…é›†æ•°:', targetEp.name);
                            } else {
                                console.log('[åˆ‡æ¢èµ„æº] æœªæ‰¾åˆ°åŒ¹é…é›†æ•°:', targetEpName, 'ä½¿ç”¨ç¬¬ä¸€é›†');
                            }
                        }
                        this.play(targetEp.url);
                    }
                },
                play(url) {
                    this.currentUrl = url;
                    this.playbackErrorCount = 0;  // é‡ç½®é”™è¯¯è®¡æ•°

                    console.log('[æ’­æ”¾å™¨] play() è¢«è°ƒç”¨');
                    console.log('[æ’­æ”¾å™¨] URL:', url?.substring(0, 50) + '...');
                    console.log('[æ’­æ”¾å™¨] currentGroup:', this.currentGroup?.name);
                    console.log('[æ’­æ”¾å™¨] episodeListé•¿åº¦:', this.episodeList?.length);
                    console.log('[æ’­æ”¾å™¨] dpå·²å­˜åœ¨:', !!dp);

                    const setupErrorHandling = () => {
                        // ç›‘å¬æ’­æ”¾é”™è¯¯ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨çº¿è·¯
                        dp.on('error', () => {
                            this.handlePlaybackError();
                        });

                        // ç›‘å¬ HLS é”™è¯¯
                        if (dp.video) {
                            dp.video.addEventListener('error', () => {
                                this.handlePlaybackError();
                            });
                        }
                    };

                    if (!dp) {
                        console.log('[æ’­æ”¾å™¨] åˆ›å»ºæ–°çš„ DPlayer å®ä¾‹');
                        dp = new DPlayer({
                            container: document.getElementById('dplayer'),
                            theme: '#e50914',
                            lang: 'zh-cn',           // ä¸­æ–‡ç•Œé¢
                            hotkey: true,            // å¿«æ·é”®æ”¯æŒ
                            preload: 'auto',         // è‡ªåŠ¨é¢„åŠ è½½
                            volume: 0.8,             // é»˜è®¤éŸ³é‡ 80%
                            loop: false,             // å¾ªç¯æ’­æ”¾ï¼ˆå¯åœ¨è®¾ç½®ä¸­åˆ‡æ¢ï¼‰
                            playbackSpeed: [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2, 3],  // 0.25é—´éš”å€é€Ÿé€‰é¡¹
                            video: { url: url, type: 'hls' },
                            contextmenu: [
                                { text: 'ğŸ¬ Eè§†ç•ŒMAX', link: '/' },
                                { text: 'âš¡ å½“å‰é€Ÿåº¦: 1x', click: () => { } }
                            ]
                        });

                        // ========== ğŸ”§ è®¾ç½®èœå•ä¿®å¤ ==========
                        setTimeout(() => {
                            const dplayerContainer = document.getElementById('dplayer');
                            const settingBox = dplayerContainer.querySelector('.dplayer-setting-box');
                            const mask = dplayerContainer.querySelector('.dplayer-mask');

                            if (settingBox && mask) {
                                // ä½¿ç”¨ MutationObserver ç›‘æ§è®¾ç½®èœå•çš„æ‰“å¼€/å…³é—­çŠ¶æ€
                                const observer = new MutationObserver((mutations) => {
                                    mutations.forEach((mutation) => {
                                        if (mutation.attributeName === 'class') {
                                            const isOpen = settingBox.classList.contains('dplayer-setting-box-open');
                                            // å½“è®¾ç½®èœå•æ‰“å¼€æ—¶ï¼Œç¦ç”¨é®ç½©å±‚çš„ç‚¹å‡»äº‹ä»¶
                                            mask.style.pointerEvents = isOpen ? 'none' : 'auto';
                                            console.log('[Settings] Menu ' + (isOpen ? 'OPENED - mask disabled' : 'CLOSED - mask enabled'));
                                        }
                                    });
                                });

                                observer.observe(settingBox, { attributes: true });

                                // å†æ¬¡ç‚¹å‡»è®¾ç½®æŒ‰é’®æ—¶å…³é—­è®¾ç½®èœå•
                                const settingIcon = dplayerContainer.querySelector('.dplayer-setting-icon');
                                if (settingIcon) {
                                    // ä½¿ç”¨ mousedown è®°å½•ç‚¹å‡»å‰çš„èœå•çŠ¶æ€
                                    let wasOpenBeforeClick = false;

                                    settingIcon.addEventListener('mousedown', () => {
                                        wasOpenBeforeClick = settingBox.classList.contains('dplayer-setting-box-open');
                                    });

                                    settingIcon.addEventListener('click', (e) => {
                                        // åªæœ‰åœ¨ç‚¹å‡»å‰èœå•å°±å·²ç»æ‰“å¼€çš„æƒ…å†µä¸‹æ‰å…³é—­
                                        if (wasOpenBeforeClick) {
                                            e.stopPropagation();
                                            settingBox.classList.remove('dplayer-setting-box-open');
                                            // åŒæ—¶å…³é—­é€Ÿåº¦é€‰æ‹©å­èœå•
                                            const settingSpeed = settingBox.querySelector('.dplayer-setting-speed');
                                            if (settingSpeed) {
                                                settingSpeed.classList.add('dplayer-setting-box-hide');
                                            }
                                            // é‡æ–°æ˜¾ç¤ºä¸»è®¾ç½®èœå•ï¼ˆéšè—çŠ¶æ€ï¼‰
                                            const settingOrigin = settingBox.querySelector('.dplayer-setting-origin');
                                            if (settingOrigin) {
                                                settingOrigin.classList.remove('dplayer-setting-box-hide');
                                            }
                                            console.log('[Settings] Toggled OFF by button click');
                                        }
                                        wasOpenBeforeClick = false; // é‡ç½®çŠ¶æ€
                                    });
                                }

                                console.log('[Settings] Fix applied - monitoring setting box state');
                            }
                        }, 500);

                        // æ·»åŠ å…¨å±æ¨ªå±åŠŸèƒ½ï¼ˆæ‰‹æœºç«¯ï¼‰
                        dp.on('fullscreen', () => {
                            if (screen.orientation && screen.orientation.lock) {
                                screen.orientation.lock('landscape').catch(() => { });
                            }
                        });

                        dp.on('fullscreen_cancel', () => {
                            if (screen.orientation && screen.orientation.unlock) {
                                screen.orientation.unlock();
                            }
                        });

                        // ========== ğŸ“± æ‰‹æœºç«¯åŒå‡»å¿«è¿›/å¿«é€€åŠŸèƒ½ ==========
                        const container = document.getElementById('dplayer');
                        let lastTap = 0;
                        let tapTimeout = null;
                        let controllerHideTimer = null;
                        const SEEK_SECONDS = 10;  // å¿«è¿›/å¿«é€€ç§’æ•°

                        // åˆ›å»ºæç¤ºå…ƒç´ 
                        const seekHintLeft = document.createElement('div');
                        seekHintLeft.className = 'dplayer-seek-hint left';
                        seekHintLeft.innerHTML = '<i class="fas fa-backward"></i><span>-10ç§’</span>';
                        container.appendChild(seekHintLeft);

                        const seekHintRight = document.createElement('div');
                        seekHintRight.className = 'dplayer-seek-hint right';
                        seekHintRight.innerHTML = '<i class="fas fa-forward"></i><span>+10ç§’</span>';
                        container.appendChild(seekHintRight);

                        // å€é€ŸæŒ‡ç¤ºå™¨
                        const speedIndicator = document.createElement('div');
                        speedIndicator.className = 'dplayer-speed-indicator';
                        container.appendChild(speedIndicator);

                        // ğŸ–¥ï¸ ç”µè„‘ç«¯ä¸­å¤®æ’­æ”¾/æš‚åœæŒ‰é’®
                        const isDesktop = window.innerWidth > 768;
                        let desktopPlayOverlay = null;

                        if (isDesktop) {
                            desktopPlayOverlay = document.createElement('div');
                            desktopPlayOverlay.className = 'desktop-play-overlay';
                            desktopPlayOverlay.innerHTML = '<i class="fas fa-play"></i>';
                            container.appendChild(desktopPlayOverlay);

                            // æ›´æ–°æ¡Œé¢æŒ‰é’®çŠ¶æ€
                            const updateDesktopOverlay = () => {
                                if (dp.video.paused) {
                                    desktopPlayOverlay.innerHTML = '<i class="fas fa-play"></i>';
                                    desktopPlayOverlay.classList.remove('pause-state');
                                    desktopPlayOverlay.classList.add('show');
                                } else {
                                    desktopPlayOverlay.innerHTML = '<i class="fas fa-pause"></i>';
                                    desktopPlayOverlay.classList.add('pause-state');
                                    // æ’­æ”¾æ—¶çŸ­æš‚æ˜¾ç¤ºåéšè—
                                    desktopPlayOverlay.classList.add('show');
                                    setTimeout(() => {
                                        if (!dp.video.paused) {
                                            desktopPlayOverlay.classList.remove('show');
                                        }
                                    }, 800);
                                }
                            };

                            // ç›‘å¬æ’­æ”¾/æš‚åœäº‹ä»¶
                            dp.on('pause', () => {
                                desktopPlayOverlay.innerHTML = '<i class="fas fa-play"></i>';
                                desktopPlayOverlay.classList.remove('pause-state');
                                desktopPlayOverlay.classList.add('show');
                            });

                            dp.on('play', () => {
                                desktopPlayOverlay.innerHTML = '<i class="fas fa-pause"></i>';
                                desktopPlayOverlay.classList.add('pause-state');
                                desktopPlayOverlay.classList.add('show');
                                // æ’­æ”¾åçŸ­æš‚æ˜¾ç¤ºç„¶åéšè—
                                setTimeout(() => {
                                    if (!dp.video.paused) {
                                        desktopPlayOverlay.classList.remove('show');
                                    }
                                }, 800);
                            });

                            // ç‚¹å‡»æŒ‰é’®åˆ‡æ¢æ’­æ”¾/æš‚åœ
                            desktopPlayOverlay.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                dp.toggle();
                            });

                            // ç‚¹å‡»è§†é¢‘åŒºåŸŸä¹Ÿæ˜¾ç¤ºæŒ‰é’®
                            container.addEventListener('click', (e) => {
                                // å¿½ç•¥æ§åˆ¶æ å’Œè®¾ç½®èœå•
                                if (e.target.closest('.dplayer-controller') ||
                                    e.target.closest('.dplayer-setting-box') ||
                                    e.target.closest('.desktop-play-overlay')) {
                                    return;
                                }

                                // å¦‚æœæŒ‰é’®éšè—ï¼Œå…ˆæ˜¾ç¤º
                                if (!desktopPlayOverlay.classList.contains('show')) {
                                    updateDesktopOverlay();
                                }
                            });
                        }

                        // ğŸ“± æ‰‹æœºç«¯ä¸­å¤®äº¤äº’æŒ‰é’®
                        const mobilePlayOverlay = document.createElement('div');
                        mobilePlayOverlay.className = 'mobile-play-overlay';
                        mobilePlayOverlay.innerHTML = '<i class="fas fa-play"></i>';
                        container.appendChild(mobilePlayOverlay);

                        // å¼ºåŠ›ç§»é™¤ DPlayer åŸç”Ÿç§»åŠ¨ç«¯å›¾æ ‡
                        const removeNativeIcons = () => {
                            const nativePlay = container.querySelector('.dplayer-mobile-play');
                            if (nativePlay) nativePlay.style.display = 'none';

                            const nativeBezels = container.querySelectorAll('.dplayer-bezel-icon');
                            nativeBezels.forEach(el => el.style.display = 'none');
                        };

                        // åˆå§‹ç§»é™¤
                        removeNativeIcons();

                        // ç›‘å¬ DOM å˜åŒ–æŒç»­ç§»é™¤ (é˜²æ­¢ DPlayer é‡æ–°åˆ›å»º)
                        const observer = new MutationObserver((mutations) => {
                            removeNativeIcons();
                        });
                        observer.observe(container, { childList: true, subtree: true });

                        // æ›´æ–°æŒ‰é’®çŠ¶æ€å‡½æ•°
                        const updateOverlayState = (overlay) => {
                            if (dp.video.paused) {
                                overlay.innerHTML = '<i class="fas fa-play"></i>';
                                overlay.classList.remove('pause-state');
                            } else {
                                overlay.innerHTML = '<i class="fas fa-pause"></i>';
                                overlay.classList.add('pause-state'); // è°ƒæ•´å›¾æ ‡å±…ä¸­
                                overlay.classList.add('show');
                            }
                            overlay.classList.add('show');
                        };

                        // ç›‘å¬æ’­æ”¾çŠ¶æ€å˜åŒ–æ¥è‡ªåŠ¨æ›´æ–° UI (å¯é€‰ï¼Œä½†ä¸ºäº†ç¡®ä¿ä¸€è‡´æ€§)
                        dp.on('play', () => {
                            if (mobilePlayOverlay.classList.contains('show')) {
                                mobilePlayOverlay.innerHTML = '<i class="fas fa-pause"></i>';
                                mobilePlayOverlay.classList.add('pause-state');
                            }
                        });

                        dp.on('pause', () => {
                            if (mobilePlayOverlay.classList.contains('show')) {
                                mobilePlayOverlay.innerHTML = '<i class="fas fa-play"></i>';
                                mobilePlayOverlay.classList.remove('pause-state');
                            }
                        });

                        // ç‚¹å‡»ä¸­å¤®æŒ‰é’®äº‹ä»¶
                        mobilePlayOverlay.addEventListener('touchend', (e) => {
                            e.preventDefault(); // é˜»æ­¢å†’æ³¡é˜²æ­¢è§¦å‘èƒŒæ™¯ç‚¹å‡»
                            e.stopPropagation();
                            dp.toggle();
                            // ç‚¹å‡»åæ›´æ–°çŠ¶æ€
                            setTimeout(() => updateOverlayState(mobilePlayOverlay), 50);
                            // äº¤äº’åé‡ç½®éšè—è®¡æ—¶å™¨
                            if (controllerHideTimer) clearTimeout(controllerHideTimer);
                            controllerHideTimer = setTimeout(() => {
                                const controller = container.querySelector('.dplayer-controller');
                                if (controller) controller.classList.remove('dplayer-controller-show');
                                mobilePlayOverlay.classList.remove('show');
                                container.classList.add('dplayer-hide-controller');
                            }, 3000);
                        });

                        // åŒå‡»æ£€æµ‹
                        // åŒå‡»æ£€æµ‹
                        container.addEventListener('touchend', (e) => {
                            // å¿½ç•¥æ§åˆ¶æ åŒºåŸŸå’Œè‡ªå®šä¹‰æŒ‰é’®çš„ç‚¹å‡»
                            // å¿½ç•¥æ§åˆ¶æ åŒºåŸŸã€è‡ªå®šä¹‰æŒ‰é’®ä»¥åŠ DPlayer é®ç½©çš„ç‚¹å‡»
                            if (e.target.closest('.dplayer-controller') ||
                                e.target.closest('.dplayer-setting-box') ||
                                e.target.closest('.mobile-play-overlay') ||
                                e.target.closest('.dplayer-mask')) {
                                return;
                            }

                            // é˜»æ­¢ DPlayer åŸç”Ÿç‚¹å‡»äº‹ä»¶ï¼Œé˜²æ­¢å†²çª
                            if (e.cancelable) {
                                e.preventDefault();
                            }

                            const now = Date.now();
                            const rect = container.getBoundingClientRect();
                            const x = e.changedTouches[0].clientX - rect.left;
                            const width = rect.width;
                            const isLeftSide = x < width * 0.35;   // å·¦ä¾§ 35%
                            const isRightSide = x > width * 0.65; // å³ä¾§ 35%
                            const isCenter = !isLeftSide && !isRightSide;  // ä¸­é—´ 30%

                            if (now - lastTap < 300) {
                                // åŒå‡»æ£€æµ‹æˆåŠŸ
                                clearTimeout(tapTimeout);

                                if (isLeftSide && dp.video) {
                                    // å·¦ä¾§åŒå‡» - å¿«é€€
                                    const newTime = Math.max(0, dp.video.currentTime - SEEK_SECONDS);
                                    dp.seek(newTime);
                                    seekHintLeft.classList.add('show');
                                    setTimeout(() => seekHintLeft.classList.remove('show'), 600);
                                } else if (isRightSide && dp.video) {
                                    // å³ä¾§åŒå‡» - å¿«è¿›
                                    const newTime = Math.min(dp.video.duration || 0, dp.video.currentTime + SEEK_SECONDS);
                                    dp.seek(newTime);
                                    seekHintRight.classList.add('show');
                                    setTimeout(() => seekHintRight.classList.remove('show'), 600);
                                } else if (isCenter) {
                                    // ä¸­é—´åŒå‡» - æš‚åœ/æ’­æ”¾
                                    dp.toggle();
                                }
                            } else {
                                // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œç­‰å¾…æ£€æµ‹åŒå‡»
                                tapTimeout = setTimeout(() => {
                                    // å•å‡» - åˆ‡æ¢æ§åˆ¶æ æ˜¾ç¤º/éšè—
                                    const controller = container.querySelector('.dplayer-controller');
                                    const overlay = container.querySelector('.mobile-play-overlay');

                                    if (controller) {
                                        // æ£€æŸ¥å½“å‰æ˜¯å¦å¯è§ (æ£€æŸ¥ opacity)
                                        const isVisible = window.getComputedStyle(controller).opacity !== '0';

                                        if (isVisible) {
                                            // å½“å‰å¯è§ -> éšè—
                                            controller.classList.remove('dplayer-controller-show');
                                            if (overlay) overlay.classList.remove('show');

                                            container.classList.add('dplayer-hide-controller'); // å¼ºåˆ¶æ·»åŠ éšè—ç±»
                                            if (controllerHideTimer) {
                                                clearTimeout(controllerHideTimer);
                                                controllerHideTimer = null;
                                            }
                                        } else {
                                            // å½“å‰éšè— -> æ˜¾ç¤º
                                            if (controllerHideTimer) clearTimeout(controllerHideTimer);
                                            controller.classList.add('dplayer-controller-show');
                                            if (overlay) updateOverlayState(overlay); // æ›´æ–°å¹¶æ˜¾ç¤º

                                            container.classList.remove('dplayer-hide-controller'); // ç§»é™¤éšè—ç±»

                                            // 4ç§’åè‡ªåŠ¨éšè—
                                            controllerHideTimer = setTimeout(() => {
                                                controller.classList.remove('dplayer-controller-show');
                                                if (overlay) overlay.classList.remove('show');
                                                container.classList.add('dplayer-hide-controller');
                                                controllerHideTimer = null;
                                            }, 4000);
                                        }
                                    }
                                }, 300);
                            }
                            lastTap = now;
                        });



                        // å€é€Ÿå˜åŒ–æ—¶æ˜¾ç¤ºæŒ‡ç¤ºå™¨
                        dp.on('ratechange', () => {
                            const rate = dp.video.playbackRate;
                            speedIndicator.textContent = `${rate}x`;
                            speedIndicator.classList.add('show');
                            clearTimeout(speedIndicator._hideTimer);
                            speedIndicator._hideTimer = setTimeout(() => {
                                speedIndicator.classList.remove('show');
                            }, 1500);
                        });

                        setupErrorHandling();

                        // ========== ğŸ• æ’­æ”¾è¿›åº¦è®°å¿†åŠŸèƒ½ (å¤–éƒ¨å®ç°) ==========
                        // æ ‡å‡†åŒ–é›†æ•°åç§°ï¼Œç¡®ä¿ä¸åŒæºä½¿ç”¨ç›¸åŒçš„ Key
                        const normalizeEpisodeName = (name) => {
                            if (!name) return 'æ­£ç‰‡';
                            // ç§»é™¤å‰å¯¼é›¶: ç¬¬01é›† -> ç¬¬1é›†, ç¬¬001é›† -> ç¬¬1é›†
                            let normalized = name.replace(/ç¬¬0*(\d+)é›†/g, 'ç¬¬$1é›†');
                            // ä¹Ÿå¤„ç†çº¯æ•°å­—: 01 -> 1
                            normalized = normalized.replace(/^0+(\d)/, '$1');
                            return normalized || 'æ­£ç‰‡';
                        };

                        // æ™ºèƒ½ Key ç”Ÿæˆï¼ˆä½¿ç”¨ this.currentUrl åŠ¨æ€è·å–å½“å‰é›†æ•°ï¼‰
                        // - ç”µå½±ï¼ˆåªæœ‰1é›†ï¼‰ï¼šå¿½ç•¥é›†æ•°åç§°ï¼ˆæ­£ç‰‡/HD/HDä¸­å­—ç­‰ï¼‰ï¼Œåªç”¨ç”µå½±å
                        // - å‰§é›†ï¼ˆå¤šé›†ï¼‰ï¼šä½¿ç”¨ç”µå½±å + æ ‡å‡†åŒ–é›†æ•°
                        const getProgressKey = () => {
                            const vodName = this.currentGroup?.name || 'unknown';

                            // å¦‚æœåªæœ‰1é›†ï¼ˆç”µå½±ï¼‰ï¼Œä¸åŠ é›†æ•°åç¼€ï¼Œè¿™æ · æ­£ç‰‡/HD/HDä¸­å­— éƒ½å…±äº«åŒä¸€ä¸ªè¿›åº¦
                            if (this.episodeList && this.episodeList.length === 1) {
                                const key = `donggua_progress_${vodName}`.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                                return key.substring(0, 80);
                            }

                            // å¤šé›†ï¼ˆå‰§é›†ï¼‰ï¼Œä½¿ç”¨ç”µå½±å + å½“å‰æ’­æ”¾é›†æ•°ï¼ˆåŠ¨æ€è·å–ï¼ï¼‰
                            let episodeName = 'æ­£ç‰‡';
                            if (this.episodeList && this.episodeList.length > 0) {
                                const currentEp = this.episodeList.find(ep => ep.url === this.currentUrl);
                                if (currentEp) {
                                    episodeName = normalizeEpisodeName(currentEp.name);
                                }
                            }
                            const combined = `${vodName}_${episodeName}`.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                            return 'donggua_progress_' + combined.substring(0, 80);
                        };

                        // æ³¨æ„ï¼šprogressKey ç°åœ¨æ˜¯åŠ¨æ€è®¡ç®—çš„ï¼Œæ¯æ¬¡è°ƒç”¨ getProgressKey() è·å–
                        console.log('[è¿›åº¦è®°å¿†] åˆå§‹ Key:', getProgressKey());

                        // æ¢å¤æ’­æ”¾è¿›åº¦
                        let progressRestored = false;
                        dp.on('canplay', () => {
                            if (progressRestored) return;

                            try {
                                const currentKey = getProgressKey();
                                const saved = localStorage.getItem(currentKey);
                                console.log('[è¿›åº¦è®°å¿†] canplay è§¦å‘, Key:', currentKey);
                                console.log('[è¿›åº¦è®°å¿†] å­˜å‚¨æ•°æ®:', saved);
                                console.log('[è¿›åº¦è®°å¿†] è§†é¢‘æ—¶é•¿:', dp.video.duration);
                                console.log('[è¿›åº¦è®°å¿†] å½“å‰æ—¶é—´:', dp.video.currentTime);
                                console.log('[è¿›åº¦è®°å¿†] æ˜¯å¦å¯seek:', dp.video.seekable.length > 0 ? `æ˜¯ (${dp.video.seekable.start(0)}-${dp.video.seekable.end(0)})` : 'å¦');

                                if (saved) {
                                    const savedData = JSON.parse(saved);
                                    const savedTime = savedData.time;
                                    const savedDate = new Date(savedData.date);
                                    const now = new Date();
                                    const daysDiff = (now - savedDate) / (1000 * 60 * 60 * 24);

                                    console.log('[è¿›åº¦è®°å¿†] ä¿å­˜æ—¶é—´:', savedTime, 'ç§’');
                                    console.log('[è¿›åº¦è®°å¿†] ä¿å­˜æ—¥æœŸ:', savedData.date, `(${daysDiff.toFixed(1)}å¤©å‰)`);

                                    // åªæ¢å¤30å¤©å†…çš„è¿›åº¦ï¼Œä¸”è¿›åº¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
                                    const isTimeOK = daysDiff < 30;
                                    const isMinOK = savedTime > 60;  // è‡³å°‘çœ‹è¿‡1åˆ†é’Ÿ
                                    const isMaxOK = dp.video.duration && savedTime < dp.video.duration - 120;  // è·ç¦»ç»“å°¾>2åˆ†é’Ÿ

                                    console.log('[è¿›åº¦è®°å¿†] æ£€æŸ¥: 30å¤©å†…=' + isTimeOK + ', >1åˆ†é’Ÿ=' + isMinOK + ', <ç»“å°¾2åˆ†é’Ÿ=' + isMaxOK);

                                    if (isTimeOK && isMinOK && isMaxOK) {
                                        console.log('[è¿›åº¦è®°å¿†] âœ… å‡†å¤‡è·³è½¬åˆ°:', savedTime);

                                        // è®°å½•è·³è½¬å‰çš„æ—¶é—´
                                        const beforeSeek = dp.video.currentTime;

                                        dp.seek(savedTime);

                                        // å»¶è¿Ÿæ£€æŸ¥è·³è½¬æ˜¯å¦æˆåŠŸ
                                        setTimeout(() => {
                                            const afterSeek = dp.video.currentTime;
                                            console.log('[è¿›åº¦è®°å¿†] è·³è½¬ç»“æœ: ä¹‹å‰=' + beforeSeek.toFixed(1) + ', ç›®æ ‡=' + savedTime + ', ä¹‹å=' + afterSeek.toFixed(1));

                                            if (Math.abs(afterSeek - savedTime) < 10) {
                                                console.log('[è¿›åº¦è®°å¿†] âœ… è·³è½¬æˆåŠŸ!');
                                            } else {
                                                console.log('[è¿›åº¦è®°å¿†] âš ï¸ è·³è½¬å¯èƒ½å¤±è´¥ï¼Œè§†é¢‘æºå¯èƒ½ä¸æ”¯æŒç²¾ç¡®è·³è½¬');
                                            }
                                        }, 1000);

                                        dp.notice(`â–¶ å·²æ¢å¤ä¸Šæ¬¡è§‚çœ‹ä½ç½® ${Math.floor(savedTime / 60)}:${String(Math.floor(savedTime % 60)).padStart(2, '0')}`, 3000);
                                    } else {
                                        console.log('[è¿›åº¦è®°å¿†] âŒ æ¡ä»¶ä¸æ»¡è¶³ï¼Œè·³è¿‡æ¢å¤');
                                    }
                                } else {
                                    console.log('[è¿›åº¦è®°å¿†] æ— ä¿å­˜è®°å½•');
                                }
                            } catch (e) {
                                console.log('[è¿›åº¦è®°å¿†] æ¢å¤å¤±è´¥:', e);
                            }
                            progressRestored = true;
                        });

                        // è¿›åº¦ä¿å­˜é€»è¾‘ï¼š
                        // - åªæœ‰å½“å‰ä½ç½® > 1åˆ†é’Ÿ æ‰ä¿å­˜ï¼ˆé˜²æ­¢ä»å¤´çœ‹çš„èµ„æºè¦†ç›–è¿›åº¦ï¼‰
                        // - å…è®¸è¿›åº¦å€’é€€ï¼ˆç”¨æˆ·å¯èƒ½é‡æ–°å¼€å§‹çœ‹ï¼‰
                        // - è·ç¦»ç»“å°¾ < 2åˆ†é’Ÿ è§†ä¸ºå®Œæ’­ï¼Œæ¸…é™¤è¿›åº¦
                        const saveProgress = (currentTime) => {
                            const duration = dp.video?.duration || 0;

                            // è·å–ç”µå½±ä¿¡æ¯ç”¨äºè§‚çœ‹å†å²
                            const movieName = this.currentGroup?.name || '';
                            const poster = this.currentGroup?.pic || '';
                            // ä½¿ç”¨ this.currentUrl è·å–å½“å‰æ­£åœ¨æ’­æ”¾çš„é›†æ•°ï¼ˆè€Œä¸æ˜¯é—­åŒ…ä¸­å›ºå®šçš„ urlï¼‰
                            const currentEp = this.episodeList?.find(ep => ep.url === this.currentUrl);
                            const episodeName = (this.episodeList?.length > 1 && currentEp) ? currentEp.name : null;

                            console.log('[è¿›åº¦è®°å¿†] å½“å‰é›†æ•°:', episodeName, 'å½“å‰URL:', this.currentUrl?.substring(0, 30));

                            // å¦‚æœè·ç¦»ç»“å°¾ < 2åˆ†é’Ÿï¼Œè§†ä¸ºå®Œæ’­ï¼Œæ¸…é™¤è¿›åº¦
                            if (duration > 0 && currentTime > duration - 120) {
                                localStorage.removeItem(getProgressKey());
                                console.log('[è¿›åº¦è®°å¿†] å³å°†å®Œæ’­ï¼Œæ¸…é™¤è¿›åº¦è®°å½•');
                                // æ›´æ–°è§‚çœ‹å†å²ï¼ˆè¿›åº¦100%ï¼‰
                                if (movieName) {
                                    this.addToWatchHistory(movieName, poster, episodeName, duration, duration, this.currentGroup);
                                }
                                return;
                            }

                            // åªæœ‰æ’­æ”¾ä½ç½® > 1åˆ†é’Ÿæ‰ä¿å­˜ï¼ˆé˜²æ­¢ä»å¤´æ’­æ”¾çš„èµ„æºè¦†ç›–è¿›åº¦ï¼‰
                            if (currentTime <= 60) {
                                console.log('[è¿›åº¦è®°å¿†] å½“å‰ä½ç½® < 1åˆ†é’Ÿï¼Œä¸ä¿å­˜è¿›åº¦å’Œå†å²');
                                return;
                            }

                            try {
                                const data = {
                                    time: Math.floor(currentTime),
                                    date: new Date().toISOString()
                                };
                                localStorage.setItem(getProgressKey(), JSON.stringify(data));
                                console.log('[è¿›åº¦è®°å¿†] ä¿å­˜è¿›åº¦:', currentTime.toFixed(0), 'ç§’, é›†æ•°:', episodeName);

                                // åŒæ—¶æ›´æ–°è§‚çœ‹å†å²ï¼ˆåªæœ‰è¿›åº¦ > 1åˆ†é’Ÿæ‰æ›´æ–°ï¼Œé˜²æ­¢è¦†ç›–ä¸º0ï¼‰
                                if (movieName) {
                                    this.addToWatchHistory(movieName, poster, episodeName, currentTime, duration, this.currentGroup);
                                }
                            } catch (e) {
                                console.log('[è¿›åº¦è®°å¿†] ä¿å­˜å¤±è´¥:', e);
                            }
                        };

                        // å®šæ—¶ä¿å­˜è¿›åº¦ (æ¯15ç§’)
                        const progressSaveInterval = setInterval(() => {
                            if (dp.video && !dp.video.paused) {
                                saveProgress(dp.video.currentTime);
                            }
                        }, 15000);

                        // æš‚åœæ—¶ä¿å­˜
                        dp.on('pause', () => {
                            if (dp.video) {
                                saveProgress(dp.video.currentTime);
                            }
                        });

                        // é¡µé¢å…³é—­å‰ä¿å­˜
                        window.addEventListener('beforeunload', () => {
                            if (dp.video) {
                                saveProgress(dp.video.currentTime);
                            }
                        });

                        // æ’­æ”¾ç»“æŸæ—¶æ¸…é™¤è¿›åº¦è®°å½•
                        dp.on('ended', () => {
                            localStorage.removeItem(getProgressKey());
                            console.log('[è¿›åº¦è®°å¿†] æ’­æ”¾å®Œæ¯•ï¼Œæ¸…é™¤è®°å½•');
                            // æ›´æ–°è§‚çœ‹å†å²ï¼ˆè¿›åº¦100%ï¼‰
                            const movieName = this.currentGroup?.name || '';
                            const poster = this.currentGroup?.pic || '';
                            const currentEp = this.episodeList?.find(ep => ep.url === this.currentUrl);
                            const episodeName = (this.episodeList?.length > 1 && currentEp) ? currentEp.name : null;
                            const duration = dp.video?.duration || 0;
                            if (movieName) {
                                this.addToWatchHistory(movieName, poster, episodeName, duration, duration, this.currentGroup);
                            }
                        });

                    } else {
                        console.log('[æ’­æ”¾å™¨] ä½¿ç”¨å·²æœ‰ DPlayer å®ä¾‹ï¼Œåˆ‡æ¢è§†é¢‘');

                        // æ ‡å‡†åŒ–é›†æ•°åç§°
                        const normalizeEpisodeName = (name) => {
                            if (!name) return 'æ­£ç‰‡';
                            let normalized = name.replace(/ç¬¬0*(\d+)é›†/g, 'ç¬¬$1é›†');
                            normalized = normalized.replace(/^0+(\d)/, '$1');
                            return normalized || 'æ­£ç‰‡';
                        };

                        // æ™ºèƒ½ Key ç”Ÿæˆï¼ˆä¸åˆå§‹åŒ–æ—¶ç›¸åŒé€»è¾‘ï¼‰
                        const getProgressKey = () => {
                            const vodName = this.currentGroup?.name || 'unknown';

                            // ç”µå½±ï¼ˆåªæœ‰1é›†ï¼‰ï¼šå¿½ç•¥é›†æ•°åç§°
                            if (this.episodeList && this.episodeList.length === 1) {
                                const key = `donggua_progress_${vodName}`.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                                return key.substring(0, 80);
                            }

                            // å‰§é›†ï¼ˆå¤šé›†ï¼‰ï¼šä½¿ç”¨ç”µå½±å + é›†æ•°
                            let episodeName = 'æ­£ç‰‡';
                            if (this.episodeList && this.episodeList.length > 0) {
                                const currentEp = this.episodeList.find(ep => ep.url === url);
                                if (currentEp) {
                                    episodeName = normalizeEpisodeName(currentEp.name);
                                }
                            }
                            const combined = `${vodName}_${episodeName}`.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                            return 'donggua_progress_' + combined.substring(0, 80);
                        };

                        const progressKey = getProgressKey();
                        console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] Key:', progressKey);
                        console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] å·²ä¿å­˜çš„æ•°æ®:', localStorage.getItem(progressKey));

                        let progressRestored = false;

                        dp.switchVideo({ url: url, type: 'hls' });
                        console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] switchVideo å·²è°ƒç”¨');

                        // æ¢å¤æ–°è§†é¢‘çš„è¿›åº¦
                        const restoreHandler = () => {
                            console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] canplay äº‹ä»¶è§¦å‘!');
                            console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] progressRestored:', progressRestored);

                            if (progressRestored) {
                                console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] å·²æ¢å¤è¿‡ï¼Œè·³è¿‡');
                                return;
                            }
                            progressRestored = true;

                            console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] è§†é¢‘æ—¶é•¿:', dp.video.duration);
                            console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] å½“å‰æ—¶é—´:', dp.video.currentTime);

                            try {
                                const saved = localStorage.getItem(progressKey);
                                console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] è¯»å–å­˜å‚¨:', saved);

                                if (saved) {
                                    const savedData = JSON.parse(saved);
                                    const savedTime = savedData.time;
                                    const savedDate = new Date(savedData.date);
                                    const daysDiff = (new Date() - savedDate) / (1000 * 60 * 60 * 24);

                                    console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] ä¿å­˜æ—¶é—´:', savedTime, 'å¤©æ•°:', daysDiff.toFixed(1));

                                    const isTimeOK = daysDiff < 7;
                                    const isMinOK = savedTime > 10;
                                    const isMaxOK = dp.video.duration && savedTime < dp.video.duration - 30;

                                    console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] æ£€æŸ¥: 7å¤©å†…=' + isTimeOK + ', >10ç§’=' + isMinOK + ', <ç»“å°¾=' + isMaxOK);

                                    if (isTimeOK && isMinOK && isMaxOK) {
                                        setTimeout(() => {
                                            console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] æ‰§è¡Œ seek åˆ°:', savedTime);
                                            dp.seek(savedTime);
                                            dp.notice(`â–¶ å·²æ¢å¤ä¸Šæ¬¡è§‚çœ‹ä½ç½®`, 2000);

                                            setTimeout(() => {
                                                console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] seekåå½“å‰æ—¶é—´:', dp.video.currentTime);
                                            }, 1000);
                                        }, 500);
                                    } else {
                                        console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] æ¡ä»¶ä¸æ»¡è¶³ï¼Œè·³è¿‡æ¢å¤');
                                    }
                                } else {
                                    console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] æ— ä¿å­˜è®°å½•');
                                }
                            } catch (e) {
                                console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] æ¢å¤å¤±è´¥:', e);
                            }
                        };

                        dp.on('canplay', restoreHandler);
                        console.log('[è¿›åº¦è®°å¿†-åˆ‡æ¢] canplay ç›‘å¬å™¨å·²æ·»åŠ ');
                    }
                    dp.play();
                },

                // å¤„ç†æ’­æ”¾é”™è¯¯ï¼Œè‡ªåŠ¨åˆ‡æ¢çº¿è·¯
                handlePlaybackError() {
                    this.playbackErrorCount++;

                    // é¿å…é‡å¤è§¦å‘
                    if (this.isAutoRetrying || this.playbackErrorCount > 1) return;

                    // è·å–å½“å‰çº¿è·¯ç´¢å¼•
                    const allSources = this.availableSources;
                    const currentIndex = allSources.findIndex(s => s.site_key === this.currentSource?.site_key);

                    // å¦‚æœè¿˜æœ‰ä¸‹ä¸€ä¸ªçº¿è·¯å¯ç”¨ï¼Œè‡ªåŠ¨åˆ‡æ¢
                    if (currentIndex >= 0 && currentIndex < allSources.length - 1) {
                        this.isAutoRetrying = true;
                        const nextSource = allSources[currentIndex + 1];

                        // æ˜¾ç¤ºç”¨æˆ·æç¤º
                        this.autoRetryMessage = `${this.currentSource?.site_name} æ’­æ”¾å¤±è´¥ï¼Œæ­£åœ¨å°è¯• ${nextSource.site_name}`;
                        console.log(`[Auto-Failover] ${this.autoRetryMessage}`);

                        // æ ‡è®°å½“å‰çº¿è·¯ä¸ºä¸å¯ç”¨ï¼ˆè®¾ç½®é«˜å»¶è¿Ÿï¼‰
                        if (this.currentSource) {
                            this.currentSource.latency = 9998;  // æ ‡è®°ä¸ºç”¨æˆ·ç«¯ä¸å¯ç”¨
                        }

                        // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªçº¿è·¯
                        setTimeout(() => {
                            this.autoRetryMessage = '';  // æ¸…é™¤æç¤º
                            this.isAutoRetrying = false;
                            this.switchSource(nextSource);
                        }, 1500);  // æ˜¾ç¤ºæç¤º1.5ç§’ååˆ‡æ¢
                    } else {
                        // æ²¡æœ‰æ›´å¤šå¯ç”¨çº¿è·¯
                        this.autoRetryMessage = 'æ‰€æœ‰çº¿è·¯å‡æ— æ³•æ’­æ”¾';
                        setTimeout(() => {
                            this.autoRetryMessage = '';
                        }, 3000);
                    }
                }
            }
        }).mount('#app');
    </script>

    <!-- Register Service Worker -->
    <script data-cfasync="false">
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered: ', reg.scope))
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>
</body>

</html>